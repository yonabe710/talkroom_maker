<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LINE風チャットレコーダー</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* 全体のスタイル */
      body {
        font-family: "Noto Sans JP", "Helvetica Neue", Arial,
          "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        margin: 0;
        background-color: #f0f0f0;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }

      .container {
        display: flex;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* チャット表示エリア */
      .chat-display {
        width: 540px;
        height: 1000px;
        background: linear-gradient(to bottom, #a5c6e7 0%, #7faedc 100%);
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .chat-display.recording-mode {
        box-shadow: none !important;
        border-radius: 0 !important;
      }

      /* 左ブロック（タイトル / メッセージ） */
      .chat-left {
        flex: 1 1 0;
        display: flex;
        flex-direction: column;
        min-height: 0; /* 子の overflow を効かせるため */
      }

      /* 右側の余白だけ欲しい場合 */
      .tiktok-blank {
        width: 50px;
        flex: 0 0 50px;
        height: auto; /* もう高さを固定しない */
      }

      .chat-blank-space {
        width: 100%;
        flex-shrink: 0;
        display: block;
      }
      .chat-title-text {
        font-size: 3em;
        color: #222;
        font-weight: bold;
        text-align: center;
        word-break: break-word;
        line-height: 1.2;
        /* text-shadow: 0 2px 8px #fff8, 0 1px 0 #fff8; */
        padding: 0 20px;
        max-width: 90%;
        white-space: pre-line;
        margin: 0 auto 32px auto;
        display: block;
      }

      /* チャットメッセージエリア */
      .chat-messages {
        width: 490px;
        flex: 1 1 0%;
        min-height: 0;
        padding: 0 0 30px 15px;
        display: flex;
        flex-direction: column;
        background: transparent;
        gap: 5px;
        position: relative;
        justify-content: flex-start;
      }

      /* ── 追加（または margin-bottom を削除して置き換え）── */
      .chat-messages::after {
        content: "";
        display: block;
        height: 80px; /* ← 欲しい余白分 */
        flex-shrink: 0; /* 折りたたまれ防止 */
      }

      /* チャットヘッダー（非表示） */
      .chat-header {
        display: none;
      }

      /* メッセージのスタイル */
      .message {
        display: flex;
        max-width: 100%;
        margin-bottom: 9px;
        align-items: flex-end;
        position: relative;
      }
      .message:last-child {
        margin-bottom: 0px;
      }

      .message .avatar {
        display: none !important;
      }

      /* 共通バブル */
      .message .bubble {
        position: relative;
        word-break: break-word;
        font-size: 18px;
        line-height: 1.6;
        max-width: 78%;
        min-width: 40px;
        padding: 10px 16px;
        border-radius: 20px;
        border: none;
        box-shadow: none;
        font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN",
          "Hiragino Sans", Meiryo, sans-serif;
        font-weight: 400;
        letter-spacing: 0.01em;
        margin: 0;
        display: inline-block;
      }

      /* 送信（右側・緑） */
      .message.sent {
        justify-content: flex-end;
        padding-left: 42px;
        padding-right: 10px;
      }
      .message.sent .bubble {
        background: #8de055;
        color: #000;
        border-radius: 20px;
      }
      .message.sent .bubble::after {
        content: "";
        position: absolute;
        display: block;
        width: 0;
        height: 0;
        right: -8px;
        top: 0px;
        border-left: 19px solid #8de055;
        border-top: 4px solid transparent;
        border-bottom: 9px solid transparent;
        transform: rotate(-35deg);
        -webkit-transform: rotate(-35deg);
      }

      /* 受信（左側・白） */
      .message.received {
        justify-content: flex-start;
        padding-right: 42px;
      }
      .message.received .bubble {
        background: #edf1ee;
        color: #000;
        border-radius: 20px;
      }
      .message.received .bubble::after {
        content: "";
        position: absolute;
        display: block;
        width: 0;
        height: 0;
        left: -6px;
        top: 0px;
        border-right: 13px solid #edf1ee;
        border-top: 2px solid transparent;
        border-bottom: 8px solid transparent;
        transform: rotate(35deg);
        -webkit-transform: rotate(35deg);
      }

      /* タイムスタンプ & 既読 */
      .message .timestamp {
        font-size: 15px;
        color: #7a8fa6;
        margin: 0 4px;
        align-self: flex-end;
        display: inline-block;
      }
      .message.sent .read-status {
        font-size: 14px;
        color: #7a8fa6;
        margin-right: 3px;
        margin-bottom: 1px;
        align-self: flex-end;
        display: inline-block;
      }
      .message.sent .meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        margin-left: 4px;
      }
      .message.received .meta {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-right: 4px;
      }

      /* 入力エリア */
      .input-area {
        flex: 1;
        background: #f7fafd;
        border-radius: 18px;
        padding: 28px 28px 20px 28px;
        box-shadow: 0 2px 12px rgba(80, 180, 80, 0.08), 0 1.5px 0 #e0f2e9;
        border: 1.5px solid #e0f2e9;
        margin-bottom: 24px;
      }

      .input-group {
        margin-bottom: 18px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 700;
        color: #3d414d;
        letter-spacing: 0.01em;
      }

      .input-group input[type="text"],
      .input-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1.5px solid #bfe6c7;
        border-radius: 12px;
        font-size: 15px;
        background: #fafdff;
        transition: border 0.2s;
        margin-bottom: 2px;
      }

      .input-group textarea {
        height: 100px;
        resize: vertical;
      }

      .section-title {
        font-size: 1.15em;
        font-weight: 700;
        color: #00c300;
        margin-bottom: 10px;
        letter-spacing: 0.02em;
      }

      /* 会話エディタカード */
      #conversationEditor {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(80, 180, 80, 0.07);
        padding: 18px 18px 10px 18px;
        margin-bottom: 18px;
        border: 1.5px solid #e0f2e9;
      }
      #conversationEditor table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 7px;
      }
      #conversationEditor th {
        font-weight: 700;
        color: #3d414d;
        background: none;
        border: none;
        padding-bottom: 4px;
      }
      #conversationEditor td {
        background: #fafdff;
        border-radius: 8px;
        padding: 7px 6px;
        border: none;
        vertical-align: middle;
        box-shadow: 0 1px 2px #e0f2e9;
      }
      #conversationEditor tr:hover td {
        background: #eaffea;
      }
      #conversationEditor button,
      #conversationEditor select {
        border-radius: 8px;
        border: 1.5px solid #bfe6c7;
        background: #fafdff;
        font-size: 1em;
        padding: 5px 12px;
        margin-right: 2px;
        cursor: pointer;
        transition: background 0.2s, border 0.2s;
      }
      #conversationEditor button:hover {
        background: #e0f2e9;
      }
      #conversationEditor input[type="text"] {
        border-radius: 8px;
        border: 1.5px solid #bfe6c7;
        padding: 6px 10px;
        font-size: 1em;
        background: #fafdff;
      }
      #conversationEditor input[type="file"] {
        border: none;
        background: none;
        font-size: 1em;
      }
      #conversationEditor img {
        border-radius: 8px;
        box-shadow: 0 1px 4px #e0f2e9;
      }
      #conversationEditor .add-btn {
        font-size: 1.1em;
        color: #00c300;
        background: none;
        border: none;
        cursor: pointer;
        margin-top: 8px;
        font-weight: 700;
        letter-spacing: 0.02em;
        display: flex;
        align-items: center;
      }
      #conversationEditor .add-btn:hover {
        color: #009900;
      }
      #conversationEditor .del-btn {
        color: #fff;
        background: #ff69b4;
        border: none;
        border-radius: 50%;
        width: 2em;
        height: 2em;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        margin-left: 4px;
        transition: background 0.2s;
      }
      #conversationEditor .del-btn:hover {
        background: #e60073;
      }

      /* CSVボタン */
      .csv-btn {
        background: #e0f2e9;
        color: #00c300;
        border: 1.5px solid #bfe6c7;
        border-radius: 8px;
        font-size: 1em;
        padding: 7px 18px;
        margin-right: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: background 0.2s, color 0.2s;
      }
      .csv-btn:hover {
        background: #00c300;
        color: #fff;
      }

      /* ヒント */
      .hint {
        font-size: 0.97em;
        color: #6a8e6a;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 0.4em;
      }
      .hint .icon {
        font-size: 1.2em;
        vertical-align: middle;
      }

      /* 設定エリア */
      .settings-area {
        margin-top: 20px;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .settings-group {
        margin-bottom: 15px;
      }

      .settings-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .settings-group input[type="range"] {
        width: 100%;
      }

      .button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .button:hover {
        background-color: #0056b3;
      }

      .button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      /* 録画用: マウス無効化・スクロールバー非表示CSSを追加 */
      .chat-display.hide-scrollbar {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE 10+ */
      }
      .chat-display.hide-scrollbar::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }
      .chat-display.disable-mouse {
        pointer-events: none !important;
      }
      .chat-display.hide-cursor {
        cursor: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- チャット表示エリア -->
      <div class="chat-display">
        <div class="chat-left">
          <div id="chatBlankSpace" class="chat-blank-space"></div>
          <div id="chatTitleText" class="chat-title-text"></div>
          <div class="chat-messages" id="chatMessages"></div>
        </div>

        <div class="tiktok-blank"></div>
      </div>

      <!-- 入力エリア -->
      <div class="input-area">
        <div style="font-size: 0.95em; color: #555; margin-bottom: 8px">
          <span class="icon">📋</span>
          <span class="hint">画像はコピー＆ペーストでも追加できます</span>
        </div>
        <div id="conversationEditor"></div>
        <div class="input-group">
          <textarea
            id="conversationInput"
            placeholder="sender,type,content[,timestamp] 例:\n男,text,こんにちは\n男,image,https://example.com/image.jpg\n女,text,こんにちは！"
            style="display: none"
          >
          </textarea>
        </div>

        <div class="input-group">
          <button id="csvExportButton" type="button" class="csv-btn">
            📤 CSVエクスポート
          </button>
          <input
            type="file"
            id="csvImportInput"
            accept=".csv,text/csv"
            style="display: none"
          />
          <button id="csvImportButton" type="button" class="csv-btn">
            📥 CSVインポート
          </button>
        </div>

        <div class="settings-area">
          <div class="settings-group">
            <label for="scrollSpeed">スクロール速度:</label>
            <input
              type="range"
              id="scrollSpeed"
              min="0.5"
              max="5"
              value="1"
              step="0.1"
            />
            <span id="scrollSpeedValue">2</span>
          </div>

          <div class="settings-group">
            <label for="chatTitleInput">タイトル:</label>
            <textarea
              id="chatTitleInput"
              placeholder="タイトルを入力"
              rows="3"
              style="resize: vertical; width: 100%; font-size: 1.1em"
            >
タイトル</textarea
            >
          </div>

          <div class="settings-group">
            <label for="titleBlankPercent">タイトル前の空白高さ（％）:</label>
            <input
              type="range"
              id="titleBlankPercent"
              min="0"
              max="50"
              value="20"
            />
            <span id="titleBlankPercentValue">20</span>%
          </div>

          <button id="startRecording" class="button">録画開始</button>
          <button id="stopRecording" class="button" disabled>録画停止</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chatMessages = document.getElementById("chatMessages");
        const chatBlankSpace = document.getElementById("chatBlankSpace");
        const chatTitleText = document.getElementById("chatTitleText");
        const conversationInput = document.getElementById("conversationInput");
        const scrollSpeed = document.getElementById("scrollSpeed");
        const scrollSpeedValue = document.getElementById("scrollSpeedValue");
        const startRecording = document.getElementById("startRecording");
        const stopRecording = document.getElementById("stopRecording");
        const chatTitleInput = document.getElementById("chatTitleInput");
        const titleBlankPercentInput =
          document.getElementById("titleBlankPercent");
        const titleBlankPercentValue = document.getElementById(
          "titleBlankPercentValue"
        );

        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let animationFrameId = null;

        // グローバル変数として宣言
        let chatTitle = chatTitleInput.value;
        let titleBlankPercent = parseInt(titleBlankPercentInput.value, 10);

        // DOMContentLoaded 内の適当な場所で
        scrollSpeedValue.textContent = scrollSpeed.value; // 初期表示を 2 に

        // 会話リストの内部データ
        let conversationRows = [];
        const conversationEditor =
          document.getElementById("conversationEditor");
        const csvExportButton = document.getElementById("csvExportButton");
        const csvImportButton = document.getElementById("csvImportButton");
        const csvImportInput = document.getElementById("csvImportInput");

        // スクロール速度の表示更新
        scrollSpeed.addEventListener("input", () => {
          // 現在値をそのまま表示するだけ
          scrollSpeedValue.textContent = scrollSpeed.value;
        });

        // 会話内容の解析と表示
        function parseAndDisplayConversation(text) {
          const lines = text.split("\n");
          chatBlankSpace.style.height = titleBlankPercent * 0.01 * 1000 + "px";
          chatTitleText.innerHTML = chatTitle
            ? chatTitle.replace(/\n/g, "<br>")
            : "";
          chatMessages.innerHTML = "";

          // メッセージエリア
          const messagesWrapper = document.createElement("div");
          messagesWrapper.style.display = "flex";
          messagesWrapper.style.flexDirection = "column";
          messagesWrapper.style.justifyContent = "flex-start";
          messagesWrapper.style.width = "100%";

          lines.forEach((line, idx) => {
            if (!line.trim()) return;
            // ヘッダー行（sender,text）や（sender,type,content）をスキップ
            const header = line.replace(/\s/g, "").toLowerCase();
            if (
              idx === 0 &&
              (header.startsWith("sender,text") ||
                header.startsWith("sender,type,content"))
            )
              return;

            // パース: sender,type,content...（カンマを含む画像データ対応）
            const parts = line.split(",");
            let sender, type, content, timestamp;
            if (parts.length >= 3) {
              sender = parts[0].trim();
              type = parts[1].trim();
              // contentは3列目以降を全て結合
              content = parts.slice(2).join(",").trim();
              // timestampはtypeがtextのときだけ4列目以降で対応（現状未対応）
            } else if (parts.length === 2) {
              // 旧形式: sender,text
              sender = parts[0].trim();
              content = parts[1].trim();
              type = "text";
            } else {
              return;
            }
            if (!sender || !content) return;

            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.classList.add(sender === "男" ? "sent" : "received");

            let bubble;
            if (type === "image") {
              // 画像のみ、バブルや吹き出しなし
              bubble = document.createElement("img");
              bubble.src = content;
              bubble.alt = "画像";
              bubble.style.width = "360px";
              bubble.style.height = "auto";
              bubble.style.borderRadius = "16px";
              bubble.style.display = "block";
              bubble.style.margin = "0";
            } else {
              bubble = document.createElement("div");
              bubble.classList.add("bubble");
              bubble.textContent = content;
            }

            // メタ情報（時刻・既読）
            const metaDiv = document.createElement("div");
            metaDiv.classList.add("meta");
            if (sender === "男") {
              // 送信側は既読＋時刻
              const readDiv = document.createElement("div");
              readDiv.classList.add("read-status");
              readDiv.textContent = "既読";
              metaDiv.appendChild(readDiv);
            }
            const timeDiv = document.createElement("div");
            timeDiv.classList.add("timestamp");
            timeDiv.textContent =
              timestamp ||
              new Date().toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
            metaDiv.appendChild(timeDiv);

            if (sender === "男") {
              messageDiv.appendChild(metaDiv);
              messageDiv.appendChild(bubble);
            } else {
              messageDiv.appendChild(bubble);
              messageDiv.appendChild(metaDiv);
            }

            messagesWrapper.appendChild(messageDiv);
          });
          chatMessages.appendChild(messagesWrapper);
        }

        // 録画開始
        startRecording.addEventListener("click", async () => {
          try {
            const chatDisplay = document.querySelector(".chat-display");
            chatDisplay.classList.add("recording-mode");

            // 新しいwindowを開き、チャットDOMとスタイルを複製
            const recWin = window.open("", "", "width=540,height=1000");
            if (!recWin) {
              alert("録画用ウィンドウのポップアップがブロックされました。");
              chatDisplay.classList.remove("recording-mode");
              return;
            }
            // スタイル複製
            let styles = "";
            for (const styleEl of document.querySelectorAll(
              'style,link[rel="stylesheet"]'
            )) {
              if (styleEl.tagName === "STYLE") {
                styles += `<style>${styleEl.innerHTML}</style>`;
              } else if (styleEl.tagName === "LINK") {
                styles += `<link rel="stylesheet" href="${styleEl.href}">`;
              }
            }
            // 録画用: マウス無効化・スクロールバー非表示・カーソル非表示CSSを追加
            styles += `<style>
                    .chat-display.hide-scrollbar {
                      scrollbar-width: none; /* Firefox */
                      -ms-overflow-style: none; /* IE 10+ */
                    }
                    .chat-display.hide-scrollbar::-webkit-scrollbar {
                      display: none; /* Chrome/Safari */
                    }
                    .chat-display.disable-mouse {
                      pointer-events: none !important;
                    }
                    .chat-display.hide-cursor {
                      cursor: none !important;
                    }
                  </style>`;
            recWin.document.write(
              "<html><head><title>　</title>" +
                styles +
                '</head><body style="margin:0;padding:0;overflow:hidden;background:#7b99c1;">'
            );
            // チャットDOM複製
            recWin.document.write('<div id="recChatRoot"></div>');
            recWin.document.write("</body></html>");
            recWin.document.close();
            // DOMが描画されるまで待つ
            await new Promise((res) => setTimeout(res, 300));
            const recRoot = recWin.document.getElementById("recChatRoot");
            recRoot.innerHTML = chatDisplay.outerHTML;
            // スクロール制御用
            const recChatDisplay = recRoot.querySelector(".chat-display");
            recChatDisplay.classList.add(
              "recording-mode",
              "hide-scrollbar",
              "disable-mouse",
              "hide-cursor"
            );
            // 録画用: 高さを1040pxに上書き
            recChatDisplay.style.height = "1040px";

            // 録画ストリーム取得: getDisplayMedia方式
            recWin.focus();
            alert(
              "録画用ウィンドウが開きました。録画ダイアログでこのウィンドウを選択してください。\n録画が始まったら元のウィンドウに戻って操作できます。"
            );
            let stream;
            try {
              stream = await recWin.navigator.mediaDevices.getDisplayMedia({
                video: { frameRate: 30, cursor: "never" },
                audio: false,
              });
            } catch (e) {
              alert("画面録画の許可が得られませんでした。");
              recWin.close();
              chatDisplay.classList.remove("recording-mode");
              return;
            }
            mediaRecorder = new MediaRecorder(stream, {
              mimeType: "video/webm;codecs=vp9",
              videoBitsPerSecond: 5000000, // 5Mbps
            });

            mediaRecorder.ondataavailable = (e) => {
              if (e.data.size > 0) {
                recordedChunks.push(e.data);
              }
            };

            mediaRecorder.onstop = async () => {
              const blob = new Blob(recordedChunks, {
                type: "video/webm",
              });
              // --- ここから上40pxをクロップ ---
              const video = document.createElement("video");
              video.src = URL.createObjectURL(blob);
              video.muted = true;
              video.playsInline = true;

              await new Promise((resolve) => {
                video.onloadedmetadata = () => {
                  const width = video.videoWidth;
                  // 上40pxをクロップして1000px分だけ保存
                  const cropY = 40;
                  const cropHeight = video.videoHeight - cropY; // 残りを全部使う
                  const canvas = document.createElement("canvas");
                  canvas.width = width;
                  canvas.height = cropHeight;
                  const ctx = canvas.getContext("2d");

                  const stream = canvas.captureStream(30);
                  const rec = new MediaRecorder(stream, {
                    mimeType: "video/webm;codecs=vp9",
                    videoBitsPerSecond: 5000000,
                  });

                  const chunks = [];
                  rec.ondataavailable = (e) => {
                    if (e.data.size > 0) chunks.push(e.data);
                  };

                  rec.onstop = () => {
                    const processedBlob = new Blob(chunks, {
                      type: "video/webm",
                    });
                    const url = URL.createObjectURL(processedBlob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "chat-recording.webm";
                    a.click();
                    URL.revokeObjectURL(url);
                    URL.revokeObjectURL(video.src);
                    recWin.close();
                    chatDisplay.classList.remove("recording-mode");
                    resolve();
                  };

                  video.currentTime = 0;
                  video.play();

                  function draw() {
                    if (video.ended || video.currentTime >= video.duration) {
                      rec.stop();
                      return;
                    }
                    // 上40pxをクロップして描画
                    ctx.drawImage(
                      video,
                      0,
                      cropY,
                      width,
                      cropHeight,
                      0,
                      0,
                      width,
                      cropHeight
                    );
                    requestAnimationFrame(draw);
                  }

                  rec.start();
                  draw();
                };
              });

              recordedChunks = [];
            };

            mediaRecorder.start();
            isRecording = true;
            startRecording.disabled = true;
            stopRecording.disabled = false;

            // スクロールアニメーション
            let scrollPos = recChatDisplay.scrollTop;
            function animate() {
              if (!isRecording) return;
              const scrollAmount = Number(scrollSpeed.value);
              scrollPos += scrollAmount;
              recChatDisplay.scrollTop = scrollPos;
              // 一番下まで到達したら自動停止
              if (
                recChatDisplay.scrollTop + recChatDisplay.clientHeight >=
                recChatDisplay.scrollHeight
              ) {
                if (mediaRecorder && isRecording) {
                  // 余白を含む最終フレームを 0.5 秒映してから停止
                  setTimeout(() => {
                    if (mediaRecorder && isRecording) {
                      mediaRecorder.stop();
                      isRecording = false;
                      startRecording.disabled = false;
                      stopRecording.disabled = true;
                    }
                  }, 500); // ← 必要に応じて長さを調整（ms）
                }
                return;
              }
              animationFrameId = recWin.requestAnimationFrame(animate);
            }
            animate();
          } catch (err) {
            console.error("録画開始エラー:", err);
            alert("録画を開始できませんでした。");
          }
        });

        // 録画停止
        stopRecording.addEventListener("click", () => {
          if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            startRecording.disabled = false;
            stopRecording.disabled = true;
          }
        });

        // 会話リスト編集UIの描画
        function renderConversationEditor() {
          conversationEditor.innerHTML = "";
          const table = document.createElement("table");
          table.style.width = "100%";
          table.style.marginBottom = "10px";
          const thead = document.createElement("thead");
          thead.innerHTML = `<tr><th>話者</th><th>投稿タイプ</th><th>内容</th><th></th></tr>`;
          table.appendChild(thead);
          const tbody = document.createElement("tbody");
          conversationRows.forEach((row, idx) => {
            const tr = document.createElement("tr");
            // 話者
            const speakerTd = document.createElement("td");
            const manBtn = document.createElement("button");
            manBtn.textContent = "男";
            manBtn.style.background = row.speaker === "男" ? "#00c300" : "#eee";
            manBtn.style.color = row.speaker === "男" ? "#fff" : "#555";
            manBtn.style.borderRadius = "50%";
            manBtn.style.width = "2.2em";
            manBtn.style.height = "2.2em";
            manBtn.style.marginRight = "2px";
            manBtn.style.border =
              row.speaker === "男"
                ? "2px solid #00c300"
                : "1.5px solid #bfe6c7";
            manBtn.onclick = () => {
              row.speaker = "男";
              renderConversationEditor();
              syncEditorToCSV();
            };
            const womanBtn = document.createElement("button");
            womanBtn.textContent = "女";
            womanBtn.style.background =
              row.speaker === "女" ? "#ff69b4" : "#eee";
            womanBtn.style.color = row.speaker === "女" ? "#fff" : "#555";
            womanBtn.style.borderRadius = "50%";
            womanBtn.style.width = "2.2em";
            womanBtn.style.height = "2.2em";
            womanBtn.style.border =
              row.speaker === "女"
                ? "2px solid #ff69b4"
                : "1.5px solid #bfe6c7";
            womanBtn.onclick = () => {
              row.speaker = "女";
              renderConversationEditor();
              syncEditorToCSV();
            };
            speakerTd.appendChild(manBtn);
            speakerTd.appendChild(womanBtn);
            tr.appendChild(speakerTd);
            // 投稿タイプ
            const typeTd = document.createElement("td");
            const typeSelect = document.createElement("select");
            typeSelect.innerHTML = `<option value="text">テキスト</option><option value="image">画像</option>`;
            typeSelect.value = row.type;
            typeSelect.onchange = (e) => {
              row.type = e.target.value;
              renderConversationEditor();
              syncEditorToCSV();
            };
            typeTd.appendChild(typeSelect);
            tr.appendChild(typeTd);
            // 内容
            const contentTd = document.createElement("td");
            if (row.type === "text") {
              const input = document.createElement("input");
              input.type = "text";
              input.value = row.content;
              input.style.width = "220px";
              input.oninput = (e) => {
                row.content = e.target.value;
                syncEditorToCSV();
              };
              contentTd.appendChild(input);
            } else {
              const fileInput = document.createElement("input");
              fileInput.type = "file";
              fileInput.accept = "image/*";
              fileInput.style.width = "180px";
              fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                  row.content = ev.target.result;
                  syncEditorToCSV();
                  renderConversationEditor();
                };
                reader.readAsDataURL(file);
              };
              contentTd.appendChild(fileInput);
              if (row.content && row.content.startsWith("data:image")) {
                const img = document.createElement("img");
                img.src = row.content;
                img.style.width = "60px";
                img.style.height = "auto";
                img.style.marginLeft = "8px";
                img.style.borderRadius = "8px";
                contentTd.appendChild(img);
              }
            }
            tr.appendChild(contentTd);
            // 削除ボタン
            const delTd = document.createElement("td");
            const delBtn = document.createElement("button");
            delBtn.textContent = "×";
            delBtn.className = "del-btn";
            delBtn.onclick = () => {
              conversationRows.splice(idx, 1);
              renderConversationEditor();
              syncEditorToCSV();
            };
            delTd.appendChild(delBtn);
            tr.appendChild(delTd);
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          conversationEditor.appendChild(table);
          // 追加ボタン
          const addBtn = document.createElement("button");
          addBtn.textContent = "＋追加";
          addBtn.className = "add-btn";
          addBtn.onclick = () => {
            conversationRows.push({ speaker: "男", type: "text", content: "" });
            renderConversationEditor();
            syncEditorToCSV();
          };
          conversationEditor.appendChild(addBtn);
        }

        // エディタ内容→CSV欄・チャットに反映
        function syncEditorToCSV() {
          // CSV生成
          let csv = "sender,type,content\n";
          conversationRows.forEach((row) => {
            let content = row.content ? row.content.replace(/\n/g, " ") : "";
            csv += `${row.speaker},${row.type},${content}\n`;
          });
          conversationInput.value = csv;
          parseAndDisplayConversation(csv);
        }

        // CSV欄→エディタに反映
        function syncCSVToEditor() {
          const lines = conversationInput.value.split(/\r?\n/);
          conversationRows = [];
          lines.forEach((line, idx) => {
            if (!line.trim()) return;
            if (
              idx === 0 &&
              line
                .replace(/\s/g, "")
                .toLowerCase()
                .startsWith("sender,type,content")
            )
              return;
            const parts = line.split(",");
            if (parts.length >= 3) {
              conversationRows.push({
                speaker: parts[0].trim(),
                type: parts[1].trim(),
                content: parts.slice(2).join(",").trim(),
              });
            }
          });
          renderConversationEditor();
        }

        // CSVエクスポート
        csvExportButton.addEventListener("click", () => {
          const blob = new Blob([conversationInput.value], {
            type: "text/csv",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "chat.csv";
          a.click();
          URL.revokeObjectURL(url);
        });

        // CSVインポート
        csvImportButton.addEventListener("click", () => {
          csvImportInput.click();
        });
        csvImportInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            conversationInput.value = ev.target.result;
            syncCSVToEditor();
            parseAndDisplayConversation(conversationInput.value);
          };
          reader.readAsText(file, "UTF-8");
        });

        // 初期CSV→エディタ
        syncCSVToEditor();

        // 会話内容の変更を監視（手動編集時もエディタに反映）
        conversationInput.addEventListener("input", () => {
          syncCSVToEditor();
        });

        // タイトル入力の反映
        chatTitleInput.addEventListener("input", (e) => {
          chatTitle = chatTitleInput.value;
          parseAndDisplayConversation(conversationInput.value);
        });

        // タイトル前空白スライダーの反映
        titleBlankPercentInput.addEventListener("input", (e) => {
          titleBlankPercent = parseInt(titleBlankPercentInput.value, 10);
          titleBlankPercentValue.textContent = titleBlankPercent;
          parseAndDisplayConversation(conversationInput.value);
        });
        // 初期値
        titleBlankPercent = parseInt(titleBlankPercentInput.value, 10);
        titleBlankPercentValue.textContent = titleBlankPercent;

        // 画像ペースト対応（グローバル）
        document.addEventListener("paste", (event) => {
          if (!event.clipboardData) return;
          const items = event.clipboardData.items;
          for (let i = 0; i < items.length; i++) {
            const item = items[i];
            if (item.type.indexOf("image") !== -1) {
              const file = item.getAsFile();
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  // 新しい画像行を追加（デフォルト男）
                  conversationRows.push({
                    speaker: "男",
                    type: "image",
                    content: e.target.result,
                  });
                  renderConversationEditor();
                  syncEditorToCSV();
                };
                reader.readAsDataURL(file);
                event.preventDefault();
                break;
              }
            }
          }
        });

        // 初期表示
        parseAndDisplayConversation(conversationInput.value);
      });
    </script>
  </body>
</html>
