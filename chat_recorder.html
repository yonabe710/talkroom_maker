<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LINEé¢¨ãƒãƒ£ãƒƒãƒˆãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      body {
        font-family: "Noto Sans JP", "Helvetica Neue", Arial,
          "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        margin: 0;
        background-color: #f0f0f0;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }

      .container {
        display: flex;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
      .chat-display {
        width: 540px;
        height: 1000px;
        background: linear-gradient(to bottom, #a5c6e7 0%, #7faedc 100%);
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .chat-display.recording-mode {
        box-shadow: none !important;
        border-radius: 0 !important;
      }

      /* å·¦ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒˆãƒ« / ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ */
      .chat-left {
        flex: 1 1 0;
        display: flex;
        flex-direction: column;
        min-height: 0; /* å­ã® overflow ã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ */
      }

      /* å³å´ã®ä½™ç™½ã ã‘æ¬²ã—ã„å ´åˆ */
      .tiktok-blank {
        width: 50px;
        flex: 0 0 50px;
        height: auto; /* ã‚‚ã†é«˜ã•ã‚’å›ºå®šã—ãªã„ */
      }

      .chat-blank-space {
        width: 100%;
        flex-shrink: 0;
        display: block;
      }
      .chat-title-text {
        font-size: 3em;
        color: #222;
        font-weight: bold;
        text-align: center;
        word-break: break-word;
        line-height: 1.2;
        /* text-shadow: 0 2px 8px #fff8, 0 1px 0 #fff8; */
        padding: 0 20px;
        max-width: 90%;
        white-space: pre-line;
        margin: 0 auto 32px auto;
        display: block;
      }

      /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
      .chat-messages {
        width: 490px;
        flex: 1 1 0%;
        min-height: 0;
        padding: 0 0 30px 15px;
        display: flex;
        flex-direction: column;
        background: transparent;
        gap: 5px;
        position: relative;
        justify-content: flex-start;
      }

      /* â”€â”€ è¿½åŠ ï¼ˆã¾ãŸã¯ margin-bottom ã‚’å‰Šé™¤ã—ã¦ç½®ãæ›ãˆï¼‰â”€â”€ */
      .chat-messages::after {
        content: "";
        display: block;
        height: 80px; /* â† æ¬²ã—ã„ä½™ç™½åˆ† */
        flex-shrink: 0; /* æŠ˜ã‚ŠãŸãŸã¾ã‚Œé˜²æ­¢ */
      }

      /* ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆéè¡¨ç¤ºï¼‰ */
      .chat-header {
        display: none;
      }

      /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .message {
        display: flex;
        max-width: 100%;
        margin-bottom: 9px;
        align-items: flex-end;
        position: relative;
      }
      .message:last-child {
        margin-bottom: 0px;
      }

      .message .avatar {
        display: none !important;
      }

      /* å…±é€šãƒãƒ–ãƒ« */
      .message .bubble {
        position: relative;
        word-break: break-word;
        font-size: 18px;
        line-height: 1.6;
        max-width: 78%;
        min-width: 40px;
        padding: 10px 16px;
        border-radius: 20px;
        border: none;
        box-shadow: none;
        font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN",
          "Hiragino Sans", Meiryo, sans-serif;
        font-weight: 400;
        letter-spacing: 0.01em;
        margin: 0;
        display: inline-block;
      }

      /* é€ä¿¡ï¼ˆå³å´ãƒ»ç·‘ï¼‰ */
      .message.sent {
        justify-content: flex-end;
        padding-left: 42px;
        padding-right: 10px;
      }
      .message.sent .bubble {
        background: #8de055;
        color: #000;
        border-radius: 20px;
      }
      .message.sent .bubble::after {
        content: "";
        position: absolute;
        display: block;
        width: 0;
        height: 0;
        right: -8px;
        top: 0px;
        border-left: 19px solid #8de055;
        border-top: 4px solid transparent;
        border-bottom: 9px solid transparent;
        transform: rotate(-35deg);
        -webkit-transform: rotate(-35deg);
      }

      /* å—ä¿¡ï¼ˆå·¦å´ãƒ»ç™½ï¼‰ */
      .message.received {
        justify-content: flex-start;
        padding-right: 42px;
      }
      .message.received .bubble {
        background: #edf1ee;
        color: #000;
        border-radius: 20px;
      }
      .message.received .bubble::after {
        content: "";
        position: absolute;
        display: block;
        width: 0;
        height: 0;
        left: -6px;
        top: 0px;
        border-right: 13px solid #edf1ee;
        border-top: 2px solid transparent;
        border-bottom: 8px solid transparent;
        transform: rotate(35deg);
        -webkit-transform: rotate(35deg);
      }

      /* ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— & æ—¢èª­ */
      .message .timestamp {
        font-size: 15px;
        color: #7a8fa6;
        margin: 0 4px;
        align-self: flex-end;
        display: inline-block;
      }
      .message.sent .read-status {
        font-size: 14px;
        color: #7a8fa6;
        margin-right: 3px;
        margin-bottom: 1px;
        align-self: flex-end;
        display: inline-block;
      }
      .message.sent .meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        margin-left: 4px;
      }
      .message.received .meta {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-right: 4px;
      }

      /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
      .input-area {
        flex: 1;
        background: #f7fafd;
        border-radius: 18px;
        padding: 28px 28px 20px 28px;
        box-shadow: 0 2px 12px rgba(80, 180, 80, 0.08), 0 1.5px 0 #e0f2e9;
        border: 1.5px solid #e0f2e9;
        margin-bottom: 24px;
      }

      .input-group {
        margin-bottom: 18px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 700;
        color: #3d414d;
        letter-spacing: 0.01em;
      }

      .input-group input[type="text"],
      .input-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1.5px solid #bfe6c7;
        border-radius: 12px;
        font-size: 15px;
        background: #fafdff;
        transition: border 0.2s;
        margin-bottom: 2px;
      }

      .input-group textarea {
        height: 100px;
        resize: vertical;
      }

      .section-title {
        font-size: 1.15em;
        font-weight: 700;
        color: #00c300;
        margin-bottom: 10px;
        letter-spacing: 0.02em;
      }

      /* ä¼šè©±ã‚¨ãƒ‡ã‚£ã‚¿ã‚«ãƒ¼ãƒ‰ */
      #conversationEditor {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(80, 180, 80, 0.07);
        padding: 18px 18px 10px 18px;
        margin-bottom: 18px;
        border: 1.5px solid #e0f2e9;
      }
      #conversationEditor table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 7px;
      }
      #conversationEditor th {
        font-weight: 700;
        color: #3d414d;
        background: none;
        border: none;
        padding-bottom: 4px;
      }
      #conversationEditor td {
        background: #fafdff;
        border-radius: 8px;
        padding: 7px 6px;
        border: none;
        vertical-align: middle;
        box-shadow: 0 1px 2px #e0f2e9;
      }
      #conversationEditor tr:hover td {
        background: #eaffea;
      }
      #conversationEditor button,
      #conversationEditor select {
        border-radius: 8px;
        border: 1.5px solid #bfe6c7;
        background: #fafdff;
        font-size: 1em;
        padding: 5px 12px;
        margin-right: 2px;
        cursor: pointer;
        transition: background 0.2s, border 0.2s;
      }
      #conversationEditor button:hover {
        background: #e0f2e9;
      }
      #conversationEditor input[type="text"] {
        border-radius: 8px;
        border: 1.5px solid #bfe6c7;
        padding: 6px 10px;
        font-size: 1em;
        background: #fafdff;
      }
      #conversationEditor input[type="file"] {
        border: none;
        background: none;
        font-size: 1em;
      }
      #conversationEditor img {
        border-radius: 8px;
        box-shadow: 0 1px 4px #e0f2e9;
      }
      #conversationEditor .add-btn {
        font-size: 1.1em;
        color: #00c300;
        background: none;
        border: none;
        cursor: pointer;
        margin-top: 8px;
        font-weight: 700;
        letter-spacing: 0.02em;
        display: flex;
        align-items: center;
      }
      #conversationEditor .add-btn:hover {
        color: #009900;
      }
      #conversationEditor .del-btn {
        color: #fff;
        background: #ff69b4;
        border: none;
        border-radius: 50%;
        width: 2em;
        height: 2em;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        margin-left: 4px;
        transition: background 0.2s;
      }
      #conversationEditor .del-btn:hover {
        background: #e60073;
      }

      /* CSVãƒœã‚¿ãƒ³ */
      .csv-btn {
        background: #e0f2e9;
        color: #00c300;
        border: 1.5px solid #bfe6c7;
        border-radius: 8px;
        font-size: 1em;
        padding: 7px 18px;
        margin-right: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: background 0.2s, color 0.2s;
      }
      .csv-btn:hover {
        background: #00c300;
        color: #fff;
      }

      /* ãƒ’ãƒ³ãƒˆ */
      .hint {
        font-size: 0.97em;
        color: #6a8e6a;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 0.4em;
      }
      .hint .icon {
        font-size: 1.2em;
        vertical-align: middle;
      }

      /* è¨­å®šã‚¨ãƒªã‚¢ */
      .settings-area {
        margin-top: 20px;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .settings-group {
        margin-bottom: 15px;
      }

      .settings-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .settings-group input[type="range"] {
        width: 100%;
      }

      .button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .button:hover {
        background-color: #0056b3;
      }

      .button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      /* éŒ²ç”»ç”¨: ãƒã‚¦ã‚¹ç„¡åŠ¹åŒ–ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤ºCSSã‚’è¿½åŠ  */
      .chat-display.hide-scrollbar {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE 10+ */
      }
      .chat-display.hide-scrollbar::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }
      .chat-display.disable-mouse {
        pointer-events: none !important;
      }
      .chat-display.hide-cursor {
        cursor: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div class="chat-display">
        <div class="chat-left">
          <div id="chatBlankSpace" class="chat-blank-space"></div>
          <div id="chatTitleText" class="chat-title-text"></div>
          <div class="chat-messages" id="chatMessages"></div>
        </div>

        <div class="tiktok-blank"></div>
      </div>

      <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
      <div class="input-area">
        <div style="font-size: 0.95em; color: #555; margin-bottom: 8px">
          <span class="icon">ğŸ“‹</span>
          <span class="hint">ç”»åƒã¯ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã§ã‚‚è¿½åŠ ã§ãã¾ã™</span>
        </div>
        <div id="conversationEditor"></div>
        <div class="input-group">
          <textarea
            id="conversationInput"
            placeholder="sender,type,content[,timestamp] ä¾‹:\nç”·,text,ã“ã‚“ã«ã¡ã¯\nç”·,image,https://example.com/image.jpg\nå¥³,text,ã“ã‚“ã«ã¡ã¯ï¼"
            style="display: none"
          >
          </textarea>
        </div>

        <div class="input-group">
          <button id="csvExportButton" type="button" class="csv-btn">
            ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
          <input
            type="file"
            id="csvImportInput"
            accept=".csv,text/csv"
            style="display: none"
          />
          <button id="csvImportButton" type="button" class="csv-btn">
            ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          </button>
        </div>

        <div class="settings-area">
          <div class="settings-group">
            <label for="scrollSpeed">ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦:</label>
            <input
              type="range"
              id="scrollSpeed"
              min="0.5"
              max="5"
              value="1"
              step="0.1"
            />
            <span id="scrollSpeedValue">2</span>
          </div>

          <div class="settings-group">
            <label for="chatTitleInput">ã‚¿ã‚¤ãƒˆãƒ«:</label>
            <textarea
              id="chatTitleInput"
              placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"
              rows="3"
              style="resize: vertical; width: 100%; font-size: 1.1em"
            >
ã‚¿ã‚¤ãƒˆãƒ«</textarea
            >
          </div>

          <div class="settings-group">
            <label for="titleBlankPercent">ã‚¿ã‚¤ãƒˆãƒ«å‰ã®ç©ºç™½é«˜ã•ï¼ˆï¼…ï¼‰:</label>
            <input
              type="range"
              id="titleBlankPercent"
              min="0"
              max="50"
              value="20"
            />
            <span id="titleBlankPercentValue">20</span>%
          </div>

          <button id="startRecording" class="button">éŒ²ç”»é–‹å§‹</button>
          <button id="stopRecording" class="button" disabled>éŒ²ç”»åœæ­¢</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chatMessages = document.getElementById("chatMessages");
        const chatBlankSpace = document.getElementById("chatBlankSpace");
        const chatTitleText = document.getElementById("chatTitleText");
        const conversationInput = document.getElementById("conversationInput");
        const scrollSpeed = document.getElementById("scrollSpeed");
        const scrollSpeedValue = document.getElementById("scrollSpeedValue");
        const startRecording = document.getElementById("startRecording");
        const stopRecording = document.getElementById("stopRecording");
        const chatTitleInput = document.getElementById("chatTitleInput");
        const titleBlankPercentInput =
          document.getElementById("titleBlankPercent");
        const titleBlankPercentValue = document.getElementById(
          "titleBlankPercentValue"
        );

        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let animationFrameId = null;

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®£è¨€
        let chatTitle = chatTitleInput.value;
        let titleBlankPercent = parseInt(titleBlankPercentInput.value, 10);

        // DOMContentLoaded å†…ã®é©å½“ãªå ´æ‰€ã§
        scrollSpeedValue.textContent = scrollSpeed.value; // åˆæœŸè¡¨ç¤ºã‚’ 2 ã«

        // ä¼šè©±ãƒªã‚¹ãƒˆã®å†…éƒ¨ãƒ‡ãƒ¼ã‚¿
        let conversationRows = [];
        const conversationEditor =
          document.getElementById("conversationEditor");
        const csvExportButton = document.getElementById("csvExportButton");
        const csvImportButton = document.getElementById("csvImportButton");
        const csvImportInput = document.getElementById("csvImportInput");

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã®è¡¨ç¤ºæ›´æ–°
        scrollSpeed.addEventListener("input", () => {
          // ç¾åœ¨å€¤ã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹ã ã‘
          scrollSpeedValue.textContent = scrollSpeed.value;
        });

        // ä¼šè©±å†…å®¹ã®è§£æã¨è¡¨ç¤º
        function parseAndDisplayConversation(text) {
          const lines = text.split("\n");
          chatBlankSpace.style.height = titleBlankPercent * 0.01 * 1000 + "px";
          chatTitleText.innerHTML = chatTitle
            ? chatTitle.replace(/\n/g, "<br>")
            : "";
          chatMessages.innerHTML = "";

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢
          const messagesWrapper = document.createElement("div");
          messagesWrapper.style.display = "flex";
          messagesWrapper.style.flexDirection = "column";
          messagesWrapper.style.justifyContent = "flex-start";
          messagesWrapper.style.width = "100%";

          lines.forEach((line, idx) => {
            if (!line.trim()) return;
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆsender,textï¼‰ã‚„ï¼ˆsender,type,contentï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
            const header = line.replace(/\s/g, "").toLowerCase();
            if (
              idx === 0 &&
              (header.startsWith("sender,text") ||
                header.startsWith("sender,type,content"))
            )
              return;

            // ãƒ‘ãƒ¼ã‚¹: sender,type,content...ï¼ˆã‚«ãƒ³ãƒã‚’å«ã‚€ç”»åƒãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
            const parts = line.split(",");
            let sender, type, content, timestamp;
            if (parts.length >= 3) {
              sender = parts[0].trim();
              type = parts[1].trim();
              // contentã¯3åˆ—ç›®ä»¥é™ã‚’å…¨ã¦çµåˆ
              content = parts.slice(2).join(",").trim();
              // timestampã¯typeãŒtextã®ã¨ãã ã‘4åˆ—ç›®ä»¥é™ã§å¯¾å¿œï¼ˆç¾çŠ¶æœªå¯¾å¿œï¼‰
            } else if (parts.length === 2) {
              // æ—§å½¢å¼: sender,text
              sender = parts[0].trim();
              content = parts[1].trim();
              type = "text";
            } else {
              return;
            }
            if (!sender || !content) return;

            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.classList.add(sender === "ç”·" ? "sent" : "received");

            let bubble;
            if (type === "image") {
              // ç”»åƒã®ã¿ã€ãƒãƒ–ãƒ«ã‚„å¹ãå‡ºã—ãªã—
              bubble = document.createElement("img");
              bubble.src = content;
              bubble.alt = "ç”»åƒ";
              bubble.style.width = "360px";
              bubble.style.height = "auto";
              bubble.style.borderRadius = "16px";
              bubble.style.display = "block";
              bubble.style.margin = "0";
            } else {
              bubble = document.createElement("div");
              bubble.classList.add("bubble");
              bubble.textContent = content;
            }

            // ãƒ¡ã‚¿æƒ…å ±ï¼ˆæ™‚åˆ»ãƒ»æ—¢èª­ï¼‰
            const metaDiv = document.createElement("div");
            metaDiv.classList.add("meta");
            if (sender === "ç”·") {
              // é€ä¿¡å´ã¯æ—¢èª­ï¼‹æ™‚åˆ»
              const readDiv = document.createElement("div");
              readDiv.classList.add("read-status");
              readDiv.textContent = "æ—¢èª­";
              metaDiv.appendChild(readDiv);
            }
            const timeDiv = document.createElement("div");
            timeDiv.classList.add("timestamp");
            timeDiv.textContent =
              timestamp ||
              new Date().toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
            metaDiv.appendChild(timeDiv);

            if (sender === "ç”·") {
              messageDiv.appendChild(metaDiv);
              messageDiv.appendChild(bubble);
            } else {
              messageDiv.appendChild(bubble);
              messageDiv.appendChild(metaDiv);
            }

            messagesWrapper.appendChild(messageDiv);
          });
          chatMessages.appendChild(messagesWrapper);
        }

        // éŒ²ç”»é–‹å§‹
        startRecording.addEventListener("click", async () => {
          try {
            const chatDisplay = document.querySelector(".chat-display");
            chatDisplay.classList.add("recording-mode");

            // æ–°ã—ã„windowã‚’é–‹ãã€ãƒãƒ£ãƒƒãƒˆDOMã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¤‡è£½
            const recWin = window.open("", "", "width=540,height=1000");
            if (!recWin) {
              alert("éŒ²ç”»ç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚");
              chatDisplay.classList.remove("recording-mode");
              return;
            }
            // ã‚¹ã‚¿ã‚¤ãƒ«è¤‡è£½
            let styles = "";
            for (const styleEl of document.querySelectorAll(
              'style,link[rel="stylesheet"]'
            )) {
              if (styleEl.tagName === "STYLE") {
                styles += `<style>${styleEl.innerHTML}</style>`;
              } else if (styleEl.tagName === "LINK") {
                styles += `<link rel="stylesheet" href="${styleEl.href}">`;
              }
            }
            // éŒ²ç”»ç”¨: ãƒã‚¦ã‚¹ç„¡åŠ¹åŒ–ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤ºãƒ»ã‚«ãƒ¼ã‚½ãƒ«éè¡¨ç¤ºCSSã‚’è¿½åŠ 
            styles += `<style>
                    .chat-display.hide-scrollbar {
                      scrollbar-width: none; /* Firefox */
                      -ms-overflow-style: none; /* IE 10+ */
                    }
                    .chat-display.hide-scrollbar::-webkit-scrollbar {
                      display: none; /* Chrome/Safari */
                    }
                    .chat-display.disable-mouse {
                      pointer-events: none !important;
                    }
                    .chat-display.hide-cursor {
                      cursor: none !important;
                    }
                  </style>`;
            recWin.document.write(
              "<html><head><title>ã€€</title>" +
                styles +
                '</head><body style="margin:0;padding:0;overflow:hidden;background:#7b99c1;">'
            );
            // ãƒãƒ£ãƒƒãƒˆDOMè¤‡è£½
            recWin.document.write('<div id="recChatRoot"></div>');
            recWin.document.write("</body></html>");
            recWin.document.close();
            // DOMãŒæç”»ã•ã‚Œã‚‹ã¾ã§å¾…ã¤
            await new Promise((res) => setTimeout(res, 300));
            const recRoot = recWin.document.getElementById("recChatRoot");
            recRoot.innerHTML = chatDisplay.outerHTML;
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ç”¨
            const recChatDisplay = recRoot.querySelector(".chat-display");
            recChatDisplay.classList.add(
              "recording-mode",
              "hide-scrollbar",
              "disable-mouse",
              "hide-cursor"
            );
            // éŒ²ç”»ç”¨: é«˜ã•ã‚’1040pxã«ä¸Šæ›¸ã
            recChatDisplay.style.height = "1040px";

            // éŒ²ç”»ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—: getDisplayMediaæ–¹å¼
            recWin.focus();
            alert(
              "éŒ²ç”»ç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ãã¾ã—ãŸã€‚éŒ²ç”»ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\néŒ²ç”»ãŒå§‹ã¾ã£ãŸã‚‰å…ƒã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«æˆ»ã£ã¦æ“ä½œã§ãã¾ã™ã€‚"
            );
            let stream;
            try {
              stream = await recWin.navigator.mediaDevices.getDisplayMedia({
                video: { frameRate: 30, cursor: "never" },
                audio: false,
              });
            } catch (e) {
              alert("ç”»é¢éŒ²ç”»ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
              recWin.close();
              chatDisplay.classList.remove("recording-mode");
              return;
            }
            mediaRecorder = new MediaRecorder(stream, {
              mimeType: "video/webm;codecs=vp9",
              videoBitsPerSecond: 5000000, // 5Mbps
            });

            mediaRecorder.ondataavailable = (e) => {
              if (e.data.size > 0) {
                recordedChunks.push(e.data);
              }
            };

            mediaRecorder.onstop = async () => {
              const blob = new Blob(recordedChunks, {
                type: "video/webm",
              });
              // --- ã“ã“ã‹ã‚‰ä¸Š40pxã‚’ã‚¯ãƒ­ãƒƒãƒ— ---
              const video = document.createElement("video");
              video.src = URL.createObjectURL(blob);
              video.muted = true;
              video.playsInline = true;

              await new Promise((resolve) => {
                video.onloadedmetadata = () => {
                  const width = video.videoWidth;
                  // ä¸Š40pxã‚’ã‚¯ãƒ­ãƒƒãƒ—ã—ã¦1000pxåˆ†ã ã‘ä¿å­˜
                  const cropY = 40;
                  const cropHeight = video.videoHeight - cropY; // æ®‹ã‚Šã‚’å…¨éƒ¨ä½¿ã†
                  const canvas = document.createElement("canvas");
                  canvas.width = width;
                  canvas.height = cropHeight;
                  const ctx = canvas.getContext("2d");

                  const stream = canvas.captureStream(30);
                  const rec = new MediaRecorder(stream, {
                    mimeType: "video/webm;codecs=vp9",
                    videoBitsPerSecond: 5000000,
                  });

                  const chunks = [];
                  rec.ondataavailable = (e) => {
                    if (e.data.size > 0) chunks.push(e.data);
                  };

                  rec.onstop = () => {
                    const processedBlob = new Blob(chunks, {
                      type: "video/webm",
                    });
                    const url = URL.createObjectURL(processedBlob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "chat-recording.webm";
                    a.click();
                    URL.revokeObjectURL(url);
                    URL.revokeObjectURL(video.src);
                    recWin.close();
                    chatDisplay.classList.remove("recording-mode");
                    resolve();
                  };

                  video.currentTime = 0;
                  video.play();

                  function draw() {
                    if (video.ended || video.currentTime >= video.duration) {
                      rec.stop();
                      return;
                    }
                    // ä¸Š40pxã‚’ã‚¯ãƒ­ãƒƒãƒ—ã—ã¦æç”»
                    ctx.drawImage(
                      video,
                      0,
                      cropY,
                      width,
                      cropHeight,
                      0,
                      0,
                      width,
                      cropHeight
                    );
                    requestAnimationFrame(draw);
                  }

                  rec.start();
                  draw();
                };
              });

              recordedChunks = [];
            };

            mediaRecorder.start();
            isRecording = true;
            startRecording.disabled = true;
            stopRecording.disabled = false;

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            let scrollPos = recChatDisplay.scrollTop;
            function animate() {
              if (!isRecording) return;
              const scrollAmount = Number(scrollSpeed.value);
              scrollPos += scrollAmount;
              recChatDisplay.scrollTop = scrollPos;
              // ä¸€ç•ªä¸‹ã¾ã§åˆ°é”ã—ãŸã‚‰è‡ªå‹•åœæ­¢
              if (
                recChatDisplay.scrollTop + recChatDisplay.clientHeight >=
                recChatDisplay.scrollHeight
              ) {
                if (mediaRecorder && isRecording) {
                  // ä½™ç™½ã‚’å«ã‚€æœ€çµ‚ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ 0.5 ç§’æ˜ ã—ã¦ã‹ã‚‰åœæ­¢
                  setTimeout(() => {
                    if (mediaRecorder && isRecording) {
                      mediaRecorder.stop();
                      isRecording = false;
                      startRecording.disabled = false;
                      stopRecording.disabled = true;
                    }
                  }, 500); // â† å¿…è¦ã«å¿œã˜ã¦é•·ã•ã‚’èª¿æ•´ï¼ˆmsï¼‰
                }
                return;
              }
              animationFrameId = recWin.requestAnimationFrame(animate);
            }
            animate();
          } catch (err) {
            console.error("éŒ²ç”»é–‹å§‹ã‚¨ãƒ©ãƒ¼:", err);
            alert("éŒ²ç”»ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
          }
        });

        // éŒ²ç”»åœæ­¢
        stopRecording.addEventListener("click", () => {
          if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            startRecording.disabled = false;
            stopRecording.disabled = true;
          }
        });

        // ä¼šè©±ãƒªã‚¹ãƒˆç·¨é›†UIã®æç”»
        function renderConversationEditor() {
          conversationEditor.innerHTML = "";
          const table = document.createElement("table");
          table.style.width = "100%";
          table.style.marginBottom = "10px";
          const thead = document.createElement("thead");
          thead.innerHTML = `<tr><th>è©±è€…</th><th>æŠ•ç¨¿ã‚¿ã‚¤ãƒ—</th><th>å†…å®¹</th><th></th></tr>`;
          table.appendChild(thead);
          const tbody = document.createElement("tbody");
          conversationRows.forEach((row, idx) => {
            const tr = document.createElement("tr");
            // è©±è€…
            const speakerTd = document.createElement("td");
            const manBtn = document.createElement("button");
            manBtn.textContent = "ç”·";
            manBtn.style.background = row.speaker === "ç”·" ? "#00c300" : "#eee";
            manBtn.style.color = row.speaker === "ç”·" ? "#fff" : "#555";
            manBtn.style.borderRadius = "50%";
            manBtn.style.width = "2.2em";
            manBtn.style.height = "2.2em";
            manBtn.style.marginRight = "2px";
            manBtn.style.border =
              row.speaker === "ç”·"
                ? "2px solid #00c300"
                : "1.5px solid #bfe6c7";
            manBtn.onclick = () => {
              row.speaker = "ç”·";
              renderConversationEditor();
              syncEditorToCSV();
            };
            const womanBtn = document.createElement("button");
            womanBtn.textContent = "å¥³";
            womanBtn.style.background =
              row.speaker === "å¥³" ? "#ff69b4" : "#eee";
            womanBtn.style.color = row.speaker === "å¥³" ? "#fff" : "#555";
            womanBtn.style.borderRadius = "50%";
            womanBtn.style.width = "2.2em";
            womanBtn.style.height = "2.2em";
            womanBtn.style.border =
              row.speaker === "å¥³"
                ? "2px solid #ff69b4"
                : "1.5px solid #bfe6c7";
            womanBtn.onclick = () => {
              row.speaker = "å¥³";
              renderConversationEditor();
              syncEditorToCSV();
            };
            speakerTd.appendChild(manBtn);
            speakerTd.appendChild(womanBtn);
            tr.appendChild(speakerTd);
            // æŠ•ç¨¿ã‚¿ã‚¤ãƒ—
            const typeTd = document.createElement("td");
            const typeSelect = document.createElement("select");
            typeSelect.innerHTML = `<option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option><option value="image">ç”»åƒ</option>`;
            typeSelect.value = row.type;
            typeSelect.onchange = (e) => {
              row.type = e.target.value;
              renderConversationEditor();
              syncEditorToCSV();
            };
            typeTd.appendChild(typeSelect);
            tr.appendChild(typeTd);
            // å†…å®¹
            const contentTd = document.createElement("td");
            if (row.type === "text") {
              const input = document.createElement("input");
              input.type = "text";
              input.value = row.content;
              input.style.width = "220px";
              input.oninput = (e) => {
                row.content = e.target.value;
                syncEditorToCSV();
              };
              contentTd.appendChild(input);
            } else {
              const fileInput = document.createElement("input");
              fileInput.type = "file";
              fileInput.accept = "image/*";
              fileInput.style.width = "180px";
              fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                  row.content = ev.target.result;
                  syncEditorToCSV();
                  renderConversationEditor();
                };
                reader.readAsDataURL(file);
              };
              contentTd.appendChild(fileInput);
              if (row.content && row.content.startsWith("data:image")) {
                const img = document.createElement("img");
                img.src = row.content;
                img.style.width = "60px";
                img.style.height = "auto";
                img.style.marginLeft = "8px";
                img.style.borderRadius = "8px";
                contentTd.appendChild(img);
              }
            }
            tr.appendChild(contentTd);
            // å‰Šé™¤ãƒœã‚¿ãƒ³
            const delTd = document.createElement("td");
            const delBtn = document.createElement("button");
            delBtn.textContent = "Ã—";
            delBtn.className = "del-btn";
            delBtn.onclick = () => {
              conversationRows.splice(idx, 1);
              renderConversationEditor();
              syncEditorToCSV();
            };
            delTd.appendChild(delBtn);
            tr.appendChild(delTd);
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          conversationEditor.appendChild(table);
          // è¿½åŠ ãƒœã‚¿ãƒ³
          const addBtn = document.createElement("button");
          addBtn.textContent = "ï¼‹è¿½åŠ ";
          addBtn.className = "add-btn";
          addBtn.onclick = () => {
            conversationRows.push({ speaker: "ç”·", type: "text", content: "" });
            renderConversationEditor();
            syncEditorToCSV();
          };
          conversationEditor.appendChild(addBtn);
        }

        // ã‚¨ãƒ‡ã‚£ã‚¿å†…å®¹â†’CSVæ¬„ãƒ»ãƒãƒ£ãƒƒãƒˆã«åæ˜ 
        function syncEditorToCSV() {
          // CSVç”Ÿæˆ
          let csv = "sender,type,content\n";
          conversationRows.forEach((row) => {
            let content = row.content ? row.content.replace(/\n/g, " ") : "";
            csv += `${row.speaker},${row.type},${content}\n`;
          });
          conversationInput.value = csv;
          parseAndDisplayConversation(csv);
        }

        // CSVæ¬„â†’ã‚¨ãƒ‡ã‚£ã‚¿ã«åæ˜ 
        function syncCSVToEditor() {
          const lines = conversationInput.value.split(/\r?\n/);
          conversationRows = [];
          lines.forEach((line, idx) => {
            if (!line.trim()) return;
            if (
              idx === 0 &&
              line
                .replace(/\s/g, "")
                .toLowerCase()
                .startsWith("sender,type,content")
            )
              return;
            const parts = line.split(",");
            if (parts.length >= 3) {
              conversationRows.push({
                speaker: parts[0].trim(),
                type: parts[1].trim(),
                content: parts.slice(2).join(",").trim(),
              });
            }
          });
          renderConversationEditor();
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        csvExportButton.addEventListener("click", () => {
          const blob = new Blob([conversationInput.value], {
            type: "text/csv",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "chat.csv";
          a.click();
          URL.revokeObjectURL(url);
        });

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        csvImportButton.addEventListener("click", () => {
          csvImportInput.click();
        });
        csvImportInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            conversationInput.value = ev.target.result;
            syncCSVToEditor();
            parseAndDisplayConversation(conversationInput.value);
          };
          reader.readAsText(file, "UTF-8");
        });

        // åˆæœŸCSVâ†’ã‚¨ãƒ‡ã‚£ã‚¿
        syncCSVToEditor();

        // ä¼šè©±å†…å®¹ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆæ‰‹å‹•ç·¨é›†æ™‚ã‚‚ã‚¨ãƒ‡ã‚£ã‚¿ã«åæ˜ ï¼‰
        conversationInput.addEventListener("input", () => {
          syncCSVToEditor();
        });

        // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ã®åæ˜ 
        chatTitleInput.addEventListener("input", (e) => {
          chatTitle = chatTitleInput.value;
          parseAndDisplayConversation(conversationInput.value);
        });

        // ã‚¿ã‚¤ãƒˆãƒ«å‰ç©ºç™½ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®åæ˜ 
        titleBlankPercentInput.addEventListener("input", (e) => {
          titleBlankPercent = parseInt(titleBlankPercentInput.value, 10);
          titleBlankPercentValue.textContent = titleBlankPercent;
          parseAndDisplayConversation(conversationInput.value);
        });
        // åˆæœŸå€¤
        titleBlankPercent = parseInt(titleBlankPercentInput.value, 10);
        titleBlankPercentValue.textContent = titleBlankPercent;

        // ç”»åƒãƒšãƒ¼ã‚¹ãƒˆå¯¾å¿œï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
        document.addEventListener("paste", (event) => {
          if (!event.clipboardData) return;
          const items = event.clipboardData.items;
          for (let i = 0; i < items.length; i++) {
            const item = items[i];
            if (item.type.indexOf("image") !== -1) {
              const file = item.getAsFile();
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  // æ–°ã—ã„ç”»åƒè¡Œã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”·ï¼‰
                  conversationRows.push({
                    speaker: "ç”·",
                    type: "image",
                    content: e.target.result,
                  });
                  renderConversationEditor();
                  syncEditorToCSV();
                };
                reader.readAsDataURL(file);
                event.preventDefault();
                break;
              }
            }
          }
        });

        // åˆæœŸè¡¨ç¤º
        parseAndDisplayConversation(conversationInput.value);
      });
    </script>
  </body>
</html>
