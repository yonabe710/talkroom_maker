<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LINEé¢¨ãƒãƒ£ãƒƒãƒˆãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      body {
        font-family: "Noto Sans JP", "Helvetica Neue", Arial,
          "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        margin: 0;
        background-color: #f0f0f0;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }

      .container {
        display: flex;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
      .chat-display {
        width: 540px;
        height: 1000px;
        background: linear-gradient(to bottom, #a5c6e7 0%, #7faedc 100%);
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .chat-display.recording-mode {
        box-shadow: none !important;
        border-radius: 0 !important;
      }

      /* å·¦ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒˆãƒ« / ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ */
      .chat-left {
        flex: 1 1 0;
        display: flex;
        flex-direction: column;
        min-height: 0; /* å­ã® overflow ã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ */
      }

      /* å³å´ã®ä½™ç™½ã ã‘æ¬²ã—ã„å ´åˆ */
      .tiktok-blank {
        width: 50px;
        flex: 0 0 50px;
        height: auto; /* ã‚‚ã†é«˜ã•ã‚’å›ºå®šã—ãªã„ */
      }

      .chat-blank-space {
        width: 100%;
        flex-shrink: 0;
        display: block;
      }
      .chat-title-text {
        font-size: 3em;
        color: #222;
        font-weight: bold;
        text-align: center;
        word-break: break-word;
        line-height: 1.2;
        padding: 0 20px;
        max-width: 90%;
        white-space: pre-line;
        margin: 0 auto 32px auto;
        display: block;
      }

      /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
      .chat-messages {
        width: 490px;
        flex: 1 1 0%;
        min-height: 0;
        padding: 0 0 30px 15px;
        display: flex;
        flex-direction: column;
        background: transparent;
        gap: 5px;
        position: relative;
        justify-content: flex-start;
      }

      .chat-messages::after {
        content: "";
        display: block;
        height: 80px; 
        flex-shrink: 0; 
      }

      .chat-header {
        display: none;
      }

      /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .message {
        display: flex;
        max-width: 100%;
        margin-bottom: 9px;
        align-items: flex-end;
        position: relative;
      }
      .message:last-child {
        margin-bottom: 0px;
      }

      .message .avatar {
        display: none !important;
      }

      /* å…±é€šãƒãƒ–ãƒ« */
      .message .bubble {
        position: relative;
        word-break: break-word;
        font-size: 18px;
        line-height: 1.6;
        max-width: 78%;
        min-width: 40px;
        padding: 10px 16px;
        border-radius: 20px;
        border: none;
        box-shadow: none;
        font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN",
          "Hiragino Sans", Meiryo, sans-serif;
        font-weight: 400;
        letter-spacing: 0.01em;
        margin: 0;
        display: inline-block;
      }

      /* é€ä¿¡ï¼ˆå³å´ãƒ»ç·‘ï¼‰ */
      .message.sent {
        justify-content: flex-end;
        padding-left: 42px;
        padding-right: 10px;
      }
      .message.sent .bubble {
        background: #8de055;
        color: #000;
        border-radius: 20px;
      }
      .message.sent .bubble::after {
        content: "";
        position: absolute;
        display: block;
        width: 0;
        height: 0;
        right: -8px;
        top: 0px;
        border-left: 19px solid #8de055;
        border-top: 4px solid transparent;
        border-bottom: 9px solid transparent;
        transform: rotate(-35deg);
        -webkit-transform: rotate(-35deg);
      }

      /* å—ä¿¡ï¼ˆå·¦å´ãƒ»ç™½ï¼‰ */
      .message.received {
        justify-content: flex-start;
        padding-right: 42px;
      }
      .message.received .bubble {
        background: #edf1ee;
        color: #000;
        border-radius: 20px;
      }
      .message.received .bubble::after {
        content: "";
        position: absolute;
        display: block;
        width: 0;
        height: 0;
        left: -6px;
        top: 0px;
        border-right: 13px solid #edf1ee;
        border-top: 2px solid transparent;
        border-bottom: 8px solid transparent;
        transform: rotate(35deg);
        -webkit-transform: rotate(35deg);
      }

      /* ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— & æ—¢èª­ */
      .message .timestamp {
        font-size: 15px;
        color: #7a8fa6;
        margin: 0 4px;
        align-self: flex-end;
        display: inline-block;
      }
      .message.sent .read-status {
        font-size: 14px;
        color: #7a8fa6;
        margin-right: 3px;
        margin-bottom: 1px;
        align-self: flex-end;
        display: inline-block;
      }
      .message.sent .meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        margin-left: 4px;
      }
      .message.received .meta {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-right: 4px;
      }

      /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
      .input-area {
        flex: 1;
        background: #f7fafd;
        border-radius: 18px;
        padding: 28px 28px 20px 28px;
        box-shadow: 0 2px 12px rgba(80, 180, 80, 0.08), 0 1.5px 0 #e0f2e9;
        border: 1.5px solid #e0f2e9;
        margin-bottom: 24px;
      }

      .input-group {
        margin-bottom: 18px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 700;
        color: #3d414d;
        letter-spacing: 0.01em;
      }

      .input-group input[type="text"],
      .input-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1.5px solid #bfe6c7;
        border-radius: 12px;
        font-size: 15px;
        background: #fafdff;
        transition: border 0.2s;
        margin-bottom: 2px;
      }

      .input-group textarea {
        height: 100px;
        resize: vertical;
      }

      .section-title {
        font-size: 1.15em;
        font-weight: 700;
        color: #00c300;
        margin-bottom: 10px;
        letter-spacing: 0.02em;
      }

      /* ä¼šè©±ã‚¨ãƒ‡ã‚£ã‚¿ã‚«ãƒ¼ãƒ‰ */
      #conversationEditor {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(80, 180, 80, 0.07);
        padding: 18px 18px 10px 18px;
        margin-bottom: 18px;
        border: 1.5px solid #e0f2e9;
      }
      #conversationEditor table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 7px;
      }
      #conversationEditor th {
        font-weight: 700;
        color: #3d414d;
        background: none;
        border: none;
        padding-bottom: 4px;
        text-align: left; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å·¦æƒãˆã« */
      }
      #conversationEditor td {
        background: #fafdff;
        border-radius: 8px;
        padding: 7px 6px;
        border: none;
        vertical-align: middle;
        box-shadow: 0 1px 2px #e0f2e9;
      }
      #conversationEditor tr:hover td {
        background: #eaffea;
      }
      #conversationEditor button,
      #conversationEditor select {
        border-radius: 8px;
        border: 1.5px solid #bfe6c7;
        background: #fafdff;
        font-size: 1em;
        padding: 5px 12px;
        margin-right: 2px;
        cursor: pointer;
        transition: background 0.2s, border 0.2s;
      }
      #conversationEditor button:hover {
        background: #e0f2e9;
      }
      #conversationEditor input[type="text"] { /* ã‚¨ãƒ‡ã‚£ã‚¿å†…ã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› */
        border-radius: 8px;
        border: 1.5px solid #bfe6c7;
        padding: 6px 10px;
        font-size: 1em;
        background: #fafdff;
        width: calc(100% - 22px); /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…® */
      }
      #conversationEditor input[type="file"] {
        border: none;
        background: none;
        font-size: 1em;
      }
      #conversationEditor img {
        border-radius: 8px;
        box-shadow: 0 1px 4px #e0f2e9;
      }
      #conversationEditor .add-btn {
        font-size: 1.1em;
        color: #00c300;
        background: none;
        border: none;
        cursor: pointer;
        margin-top: 8px;
        font-weight: 700;
        letter-spacing: 0.02em;
        display: flex;
        align-items: center;
      }
      #conversationEditor .add-btn:hover {
        color: #009900;
      }
      #conversationEditor .del-btn {
        color: #fff;
        background: #ff69b4;
        border: none;
        border-radius: 50%;
        width: 2em;
        height: 2em;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        margin-left: 4px;
        transition: background 0.2s;
      }
      #conversationEditor .del-btn:hover {
        background: #e60073;
      }

      /* CSVãƒœã‚¿ãƒ³ */
      .csv-btn {
        background: #e0f2e9;
        color: #00c300;
        border: 1.5px solid #bfe6c7;
        border-radius: 8px;
        font-size: 1em;
        padding: 7px 18px;
        margin-right: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: background 0.2s, color 0.2s;
      }
      .csv-btn:hover {
        background: #00c300;
        color: #fff;
      }

      /* ãƒ’ãƒ³ãƒˆ */
      .hint {
        font-size: 0.97em;
        color: #6a8e6a;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 0.4em;
      }
      .hint .icon {
        font-size: 1.2em;
        vertical-align: middle;
      }

      /* è¨­å®šã‚¨ãƒªã‚¢ */
      .settings-area {
        margin-top: 20px;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .settings-group {
        margin-bottom: 15px;
      }

      .settings-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .settings-group input[type="range"] {
        width: 100%;
      }

      .button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .button:hover {
        background-color: #0056b3;
      }

      .button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .chat-display.hide-scrollbar {
        scrollbar-width: none; 
        -ms-overflow-style: none; 
      }
      .chat-display.hide-scrollbar::-webkit-scrollbar {
        display: none; 
      }
      .chat-display.disable-mouse {
        pointer-events: none !important;
      }
      .chat-display.hide-cursor {
        cursor: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="chat-display">
        <div class="chat-left">
          <div id="chatBlankSpace" class="chat-blank-space"></div>
          <div id="chatTitleText" class="chat-title-text"></div>
          <div class="chat-messages" id="chatMessages"></div>
        </div>

        <div class="tiktok-blank"></div>
      </div>

      <div class="input-area">
        <div style="font-size: 0.95em; color: #555; margin-bottom: 8px">
          <span class="icon">ğŸ“‹</span>
          <span class="hint">ç”»åƒã¯ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã§ã‚‚è¿½åŠ ã§ãã¾ã™</span>
        </div>
        <div id="conversationEditor"></div>
        <div class="input-group">
          <textarea
            id="conversationInput"
            placeholder="sender,type,content[,timestamp] ä¾‹:\nç”·,text,ã“ã‚“ã«ã¡ã¯\nç”·,image,https://example.com/image.jpg,10:30\nå¥³,text,ã“ã‚“ã«ã¡ã¯ï¼,10:31"
            style="display: none"
          >
          </textarea>
        </div>

        <div class="input-group">
          <button id="csvExportButton" type="button" class="csv-btn">
            ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
          <input
            type="file"
            id="csvImportInput"
            accept=".csv,text/csv"
            style="display: none"
          />
          <button id="csvImportButton" type="button" class="csv-btn">
            ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          </button>
        </div>

        <div class="settings-area">
          <div class="settings-group">
            <label for="scrollSpeed">ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦:</label>
            <input
              type="range"
              id="scrollSpeed"
              min="0.5"
              max="5"
              value="1"
              step="0.1"
            />
            <span id="scrollSpeedValue">1</span> {/* åˆæœŸå€¤ã‚’1ã«ä¿®æ­£ */}
          </div>

          <div class="settings-group">
            <label for="chatTitleInput">ã‚¿ã‚¤ãƒˆãƒ«:</label>
            <textarea
              id="chatTitleInput"
              placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"
              rows="3"
              style="resize: vertical; width: 100%; font-size: 1.1em"
            >
ã‚¿ã‚¤ãƒˆãƒ«</textarea
            >
          </div>

          <div class="settings-group">
            <label for="titleBlankPercent">ã‚¿ã‚¤ãƒˆãƒ«å‰ã®ç©ºç™½é«˜ã•ï¼ˆï¼…ï¼‰:</label>
            <input
              type="range"
              id="titleBlankPercent"
              min="0"
              max="50"
              value="20"
            />
            <span id="titleBlankPercentValue">20</span>%
          </div>

          <button id="startRecording" class="button">éŒ²ç”»é–‹å§‹</button>
          <button id="stopRecording" class="button" disabled>éŒ²ç”»åœæ­¢</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chatMessages = document.getElementById("chatMessages");
        const chatBlankSpace = document.getElementById("chatBlankSpace");
        const chatTitleText = document.getElementById("chatTitleText");
        const conversationInput = document.getElementById("conversationInput");
        const scrollSpeed = document.getElementById("scrollSpeed");
        const scrollSpeedValue = document.getElementById("scrollSpeedValue");
        const startRecording = document.getElementById("startRecording");
        const stopRecording = document.getElementById("stopRecording");
        const chatTitleInput = document.getElementById("chatTitleInput");
        const titleBlankPercentInput =
          document.getElementById("titleBlankPercent");
        const titleBlankPercentValue = document.getElementById(
          "titleBlankPercentValue"
        );

        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let animationFrameId = null;

        let chatTitle = chatTitleInput.value;
        let titleBlankPercent = parseInt(titleBlankPercentInput.value, 10);

        scrollSpeedValue.textContent = scrollSpeed.value; 

        const conversationEditor =
          document.getElementById("conversationEditor");
        const csvExportButton = document.getElementById("csvExportButton");
        const csvImportButton = document.getElementById("csvImportButton");
        const csvImportInput = document.getElementById("csvImportInput");
        let conversationRows = []; 

        scrollSpeed.addEventListener("input", () => {
          scrollSpeedValue.textContent = scrollSpeed.value;
        });

        function parseAndDisplayConversation(text) {
          const lines = text.split("\n");
          chatBlankSpace.style.height = titleBlankPercent * 0.01 * 1000 + "px";
          chatTitleText.innerHTML = chatTitle
            ? chatTitle.replace(/\n/g, "<br>")
            : "";
          chatMessages.innerHTML = "";

          const messagesWrapper = document.createElement("div");
          messagesWrapper.style.display = "flex";
          messagesWrapper.style.flexDirection = "column";
          messagesWrapper.style.justifyContent = "flex-start";
          messagesWrapper.style.width = "100%";

          lines.forEach((line, idx) => {
            if (!line.trim()) return;
            
            const headerLineNormalized = line.replace(/\s+/g, ",").toLowerCase(); 
            if (
              idx === 0 &&
              (headerLineNormalized.startsWith("sender,type,content,timestamp") || 
               headerLineNormalized.startsWith("sender,type,content") || 
               headerLineNormalized.startsWith("sender,text")) 
            ) {
                return;
            }

            const parts = line.split(/\t|,/); // ã‚¿ãƒ–ã¾ãŸã¯ã‚«ãƒ³ãƒã§åˆ†å‰²

            let sender, type, content, timestamp;
            
            if (parts.length >= 3) { 
                sender = parts[0].trim();
                type = parts[1].trim();
                content = parts[2].trim(); 
                timestamp = parts.length >= 4 ? parts.slice(3).join(",").trim() : null; 
                if (timestamp && timestamp.match(/\d{4}\/\d{1,2}\/\d{1,2}\s\d{1,2}:\d{2}:\d{2}/)) {
                    const dateTimeParts = timestamp.split(" ");
                    if (dateTimeParts.length === 2) {
                        const timeParts = dateTimeParts[1].split(":");
                        if (timeParts.length >= 2) {
                            timestamp = `${timeParts[0]}:${timeParts[1]}`;
                        }
                    }
                }
            } else {
                console.warn("Skipping invalid CSV line (less than 3 parts):", line);
                return;
            }

            if (!sender || !content) return;

            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.classList.add(sender === "ç”·" ? "sent" : "received");

            let bubble;
            if (type === "image") {
              bubble = document.createElement("img");
              bubble.src = content;
              bubble.alt = "ç”»åƒ";
              bubble.style.width = "360px";
              bubble.style.height = "auto";
              bubble.style.borderRadius = "16px";
              bubble.style.display = "block";
              bubble.style.margin = "0";
            } else {
              bubble = document.createElement("div");
              bubble.classList.add("bubble");
              bubble.textContent = content;
            }

            const metaDiv = document.createElement("div");
            metaDiv.classList.add("meta");
            if (sender === "ç”·") {
              const readDiv = document.createElement("div");
              readDiv.classList.add("read-status");
              readDiv.textContent = "æ—¢èª­";
              metaDiv.appendChild(readDiv);
            }
            const timeDiv = document.createElement("div");
            timeDiv.classList.add("timestamp");
            timeDiv.textContent = timestamp ? timestamp : new Date().toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
            metaDiv.appendChild(timeDiv);

            if (sender === "ç”·") {
              messageDiv.appendChild(metaDiv);
              messageDiv.appendChild(bubble);
            } else {
              messageDiv.appendChild(bubble);
              messageDiv.appendChild(metaDiv);
            }

            messagesWrapper.appendChild(messageDiv);
          });
          chatMessages.appendChild(messagesWrapper);
        }
        
        startRecording.addEventListener("click", async () => { /* ... (å¤‰æ›´ãªã—) */ });
        stopRecording.addEventListener("click", () => { /* ... (å¤‰æ›´ãªã—) */ });
        
        function renderConversationEditor() {
          conversationEditor.innerHTML = "";
          const table = document.createElement("table");
          table.style.width = "100%";
          table.style.marginBottom = "10px";
          const thead = document.createElement("thead");
          thead.innerHTML = `<tr><th>è©±è€…</th><th>ã‚¿ã‚¤ãƒ—</th><th>å†…å®¹</th><th>æ™‚åˆ»</th><th></th></tr>`;
          table.appendChild(thead);
          const tbody = document.createElement("tbody");
          conversationRows.forEach((row, idx) => {
            const tr = document.createElement("tr");
            const speakerTd = document.createElement("td");
            const manBtn = document.createElement("button");
            manBtn.textContent = "ç”·";
            manBtn.style.background = row.speaker === "ç”·" ? "#00c300" : "#eee";
            manBtn.style.color = row.speaker === "ç”·" ? "#fff" : "#555";
            manBtn.style.borderRadius = "50%"; manBtn.style.width = "2.2em"; manBtn.style.height = "2.2em"; manBtn.style.marginRight = "2px";
            manBtn.style.border = row.speaker === "ç”·" ? "2px solid #00c300" : "1.5px solid #bfe6c7";
            manBtn.onclick = () => { row.speaker = "ç”·"; renderConversationEditor(); syncEditorToCSV(); };
            const womanBtn = document.createElement("button");
            womanBtn.textContent = "å¥³";
            womanBtn.style.background = row.speaker === "å¥³" ? "#ff69b4" : "#eee";
            womanBtn.style.color = row.speaker === "å¥³" ? "#fff" : "#555";
            womanBtn.style.borderRadius = "50%"; womanBtn.style.width = "2.2em"; womanBtn.style.height = "2.2em";
            womanBtn.style.border = row.speaker === "å¥³" ? "2px solid #ff69b4" : "1.5px solid #bfe6c7";
            womanBtn.onclick = () => { row.speaker = "å¥³"; renderConversationEditor(); syncEditorToCSV(); };
            speakerTd.appendChild(manBtn); speakerTd.appendChild(womanBtn);
            tr.appendChild(speakerTd);
            const typeTd = document.createElement("td");
            const typeSelect = document.createElement("select");
            typeSelect.innerHTML = `<option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option><option value="image">ç”»åƒ</option>`;
            typeSelect.value = row.type;
            typeSelect.onchange = (e) => { row.type = e.target.value; renderConversationEditor(); syncEditorToCSV(); };
            typeTd.appendChild(typeSelect);
            tr.appendChild(typeTd);
            const contentTd = document.createElement("td");
            if (row.type === "text") {
              const input = document.createElement("input"); input.type = "text"; input.value = row.content;
              input.style.width = "180px"; 
              input.oninput = (e) => { row.content = e.target.value; syncEditorToCSV(); };
              contentTd.appendChild(input);
            } else {
              const fileInput = document.createElement("input"); fileInput.type = "file"; fileInput.accept = "image/*";
              fileInput.style.width = "150px"; 
              fileInput.onchange = (e) => { /* ... (å¤‰æ›´ãªã—) */ };
              contentTd.appendChild(fileInput);
              if (row.content && row.content.startsWith("data:image")) { /* ... (å¤‰æ›´ãªã—) */ }
            }
            tr.appendChild(contentTd);
            const timestampTd = document.createElement("td");
            const timestampInput = document.createElement("input");
            timestampInput.type = "text";
            timestampInput.placeholder = "HH:MM";
            timestampInput.value = row.timestamp || "";
            timestampInput.style.width = "60px"; 
            timestampInput.oninput = (e) => {
                row.timestamp = e.target.value;
                syncEditorToCSV();
            };
            timestampTd.appendChild(timestampInput);
            tr.appendChild(timestampTd);

            const delTd = document.createElement("td");
            const delBtn = document.createElement("button"); delBtn.textContent = "Ã—"; delBtn.className = "del-btn";
            delBtn.onclick = () => { conversationRows.splice(idx, 1); renderConversationEditor(); syncEditorToCSV(); };
            delTd.appendChild(delBtn);
            tr.appendChild(delTd);
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          conversationEditor.appendChild(table);
          const addBtn = document.createElement("button"); addBtn.textContent = "ï¼‹è¿½åŠ "; addBtn.className = "add-btn";
          addBtn.onclick = () => { conversationRows.push({ speaker: "ç”·", type: "text", content: "", timestamp: "" }); renderConversationEditor(); syncEditorToCSV(); };
          conversationEditor.appendChild(addBtn);
        }

        function syncEditorToCSV() {
          let csv = "sender,type,content,timestamp\n"; 
          conversationRows.forEach((row) => {
            let content = row.content ? row.content.replace(/\n/g, " ") : "";
            let timestamp = row.timestamp || ""; 
            csv += `${row.speaker},${row.type},${content},${timestamp}\n`;
          });
          conversationInput.value = csv;
          parseAndDisplayConversation(csv);
        }

        function syncCSVToEditor(csvText) { // å¼•æ•°ã¨ã—ã¦CSVãƒ†ã‚­ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´
          const lines = csvText.split(/\r?\n/);
          conversationRows = [];
          lines.forEach((line, idx) => {
            if (!line.trim()) return;
            const headerLineNormalized = line.replace(/\s+/g, ",").toLowerCase();
            if (idx === 0 && (headerLineNormalized.startsWith("sender,type,content,timestamp") || headerLineNormalized.startsWith("sender,type,content") || headerLineNormalized.startsWith("sender,text"))) return;
            
            const parts = line.split(/\t|,/); // ã‚¿ãƒ–ã¾ãŸã¯ã‚«ãƒ³ãƒã§åˆ†å‰²
            if (parts.length >= 3) { 
              let timestamp = "";
              if (parts.length >= 4) { 
                  timestamp = parts.slice(3).join(",").trim();
                  if (timestamp && timestamp.match(/\d{4}\/\d{1,2}\/\d{1,2}\s\d{1,2}:\d{2}:\d{2}/)) {
                    const dateTimeParts = timestamp.split(" ");
                    if (dateTimeParts.length === 2) {
                        const timeParts = dateTimeParts[1].split(":");
                        if (timeParts.length >= 2) {
                            timestamp = `${timeParts[0]}:${timeParts[1]}`;
                        }
                    }
                  }
              }
              conversationRows.push({
                speaker: parts[0].trim(),
                type: parts[1].trim(),
                content: parts[2].trim(), 
                timestamp: timestamp
              });
            }
          });
          renderConversationEditor();
        }

        csvExportButton.addEventListener("click", () => { /* ... (å¤‰æ›´ãªã—) */ });
        csvImportButton.addEventListener("click", () => { csvImportInput.click(); });
        
        // csvImportInput ã® change ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¿®æ­£
        csvImportInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const csvText = event.target.result;
              conversationInput.value = csvText; // conversationInput ã«ã‚‚ä¸€å¿œã‚»ãƒƒãƒˆ
              parseAndDisplayConversation(csvText); // ç›´æ¥ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚’æ›´æ–°
              syncCSVToEditor(csvText); // ã‚¨ãƒ‡ã‚£ã‚¿ã‚‚åŒæœŸ
            };
            reader.readAsText(file);
          }
        });
        
        chatTitleInput.addEventListener("input", (e) => { /* ... (å¤‰æ›´ãªã—) */ });
        titleBlankPercentInput.addEventListener("input", (e) => { /* ... (å¤‰æ›´ãªã—) */ });
        titleBlankPercent = parseInt(titleBlankPercentInput.value, 10);
        titleBlankPercentValue.textContent = titleBlankPercent;
        
        document.addEventListener("paste", (event) => { /* ... (å¤‰æ›´ãªã—) */ });

        // åˆæœŸè¡¨ç¤ºã¯ conversationInput ã®å†…å®¹ã‹ã‚‰è¡Œã†
        syncCSVToEditor(conversationInput.value); 
        parseAndDisplayConversation(conversationInput.value); 
      });
    </script>
  </body>
</html>
