<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE風チャットアプリ (背景色rgb指定版)</title>
    <style>
        /* 全体のスタイル */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            margin: 0;
            background-color: #7b99c1; /* 外側の背景色 */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        /* 操作エリアの共通スタイル */
        .action-area {
            background-color: #f0f0f0;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column; 
            gap: 10px; 
            width: 100%;
            max-width: 450px;
        }
        .action-area .input-group { 
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .action-area label {
            font-size: 0.9em;
            margin-right: 5px;
            white-space: nowrap; 
        }
        .action-area input[type="file"],
        .action-area input[type="text"] { 
            font-size: 0.9em;
            border: 1px solid #ccc;
            padding: 5px 8px;
            border-radius: 4px;
            flex-grow: 1; 
            min-width: 100px; 
        }
        .action-area button {
            padding: 8px 12px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            align-self: flex-start; 
        }
        .action-area button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* 各ボタンの個別スタイル */
        #loadCsvButton { background-color: #28a745; }
        #loadCsvButton:hover { background-color: #218838; }

        #prepareScreenshotButton { background-color: #007bff; }
        #prepareScreenshotButton:hover { background-color: #0056b3; }

        #setWomanAvatarButton { background-color: #ffc107; color: #212529;} 
        #setWomanAvatarButton:hover { background-color: #e0a800; }

        #insertImageButton { background-color: #17a2b8; }
        #insertImageButton.cancel-mode { background-color: #dc3545; } 
        #insertImageButton:hover { background-color: #138496; }
        #insertImageButton.cancel-mode:hover { background-color: #c82333; }


        /* チャットコンテナのスタイル */
        .chat-container {
            width: 100%;
            max-width: 450px;
            height: 60vh; 
            max-height: 550px;
            background-color: #ffffff; /* チャットコンテナ自体の背景は白 */
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* チャットヘッダーのスタイル */
        .chat-header {
            background-color: #3d414d;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            border-bottom: 1px solid #353842;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .chat-header .status-icons { font-size: 0.9em; opacity: 0.8; }

        /* メッセージ表示エリアのスタイル */
        .chat-messages {
            flex-grow: 1;
            padding: 10px 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: rgb(140, 171, 217); /* 指定されたRGB値に変更 */
            gap: 5px;
        }

        /* 個々のメッセージのスタイル */
        .message {
            display: flex;
            max-width: 100%; /* 親要素に対して100% */
            margin-bottom: 10px;
            align-items: flex-end; 
            box-sizing: border-box; /* パディングとボーダーを幅に含める */
        }

        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            margin-bottom: 5px; 
        }

        .message .bubble { 
            padding: 10px 15px;
            border-radius: 16px; 
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            max-width: 75%; /* メッセージエリアの幅に対して75% */
        }
        
        .message.sent .bubble::after { 
            content: '';
            position: absolute;
            top: 8px;      
            right: -8px;    
            width: 0;
            height: 0;
            border-top: 8px solid transparent;    
            border-bottom: 8px solid transparent; 
            border-left: 10px solid #8de048;   
        }

        .message.received .bubble::before { 
            content: '';
            position: absolute;
            top: 8px;      
            left: -8px;     
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 10px solid #ffffff; 
        }

        /* 画像メッセージ用のスタイル */
        .chat-image-link {
            display: block;
            max-width: 70%; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .chat-image {
            max-width: 100%; 
            display: block; 
            border-radius: 10px; 
        }
        
        /* 画像挿入マーカーのスタイル */
        .insertion-marker {
            background-color: rgba(76, 175, 80, 0.8); 
            color: white;
            padding: 6px 0; 
            margin: 3px 0;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 0.8em;
            border: 1px dashed #fff;
            transition: background-color 0.2s ease;
        }
        .insertion-marker:hover {
            background-color: rgba(69, 160, 73, 0.9);
        }


        .message.received .speaker-name {
            display: none; 
        }

        .message .timestamp {
            font-size: 0.65em; 
            color: #777;
            white-space: nowrap; 
            margin-bottom: 5px; 
        }
        
        .message.sent .status-timestamp-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end; 
            margin-right: 5px; 
        }
        .message.sent .read-status {
            font-size: 0.6em; 
            color: #777;
            margin-bottom: 0.6px; 
        }

        .message.sent {
            justify-content: flex-end; 
            padding-left: 10px; 
        }
        .message.sent .bubble,
        .message.sent .chat-image-link { 
            background-color: #8de048; 
        }
         .message.sent .avatar {
            display: none; 
        }

        .message.received {
            justify-content: flex-start; 
            padding-right: 10px; 
        }
        .message.received .avatar {
            margin-right: 10px;
        }
        .message.received .bubble,
        .message.received .chat-image-link { 
            background-color: #ffffff;
            margin-left: 10px; 
        }
         .message.received .chat-image-link {
            margin-left: 0; 
         }

        .message.received .timestamp {
            margin-left: 5px; 
        }

        .chat-input-area {
            display: flex;
            padding: 10px 15px;
            border-top: 1px solid #ddd;
            background-color: #f5f5f5;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        #speakerSelector { padding: 10px; border-radius: 20px; border: 1px solid #ccc; background-color: white; font-size: 0.9em; flex-shrink: 0; }
        #messageInput { flex-grow: 1; padding: 12px 18px; border: 1px solid #ccc; border-radius: 20px; font-size: 1em; outline: none; }
        #messageInput:focus { border-color: #8de048; box-shadow: 0 0 5px rgba(141, 224, 72, 0.5); }
        #sendMessageButton { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 1.2em; cursor: pointer; transition: background-color 0.2s ease; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        #sendMessageButton:hover { background-color: #0056b3; }
        #sendMessageButton svg { width: 20px; height: 20px; fill: white; }

        @media (max-width: 480px) {
            body { padding: 0; }
            .action-area { border-radius: 0; margin-bottom: 0; border-bottom: 1px solid #ddd; }
            .action-area .input-group { flex-direction: column; align-items: flex-start; } 
            .action-area input[type="file"],
            .action-area input[type="text"],
            .action-area button { width: 100%; margin-bottom: 5px; } 

            .chat-container { height: calc(100vh - 220px); max-height: none; border-radius: 0; }
        }
    </style>
</head>
<body>
    <div class="action-area">
        <div class="input-group">
            <label for="csvFile">CSV読込:</label>
            <input type="file" id="csvFile" accept=".csv,text/csv">
            <button id="loadCsvButton" disabled>読込実行</button>
        </div>
        <div class="input-group">
            <label for="womanAvatarUrl">女性アイコンURL:</label>
            <input type="text" id="womanAvatarUrl" placeholder="画像のURLを入力">
            <button id="setWomanAvatarButton">設定</button>
        </div>
        <div class="input-group"> 
            <label for="imageFile">画像挿入:</label>
            <input type="file" id="imageFile" accept="image/*" style="display: none;"> 
            <button id="insertImageButton">画像を選択して挿入位置を指定</button>
        </div>
        <div class="input-group"> 
             <button id="prepareScreenshotButton" style="width: auto;">チャットを画像/PDFで保存準備</button>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <span>トークルーム</span>
            <div class="status-icons">📶 <span>100%</span></div>
        </div>
        <div class="chat-messages" id="chatMessages">
            </div>
        <div class="chat-input-area">
            <select id="speakerSelector">
                <option value="man">男性</option>
                <option value="woman">女性</option>
            </select>
            <input type="text" id="messageInput" placeholder="メッセージを入力...">
            <button id="sendMessageButton" title="送信">
                <svg viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CSV関連の要素取得とイベントリスナー登録を優先的に行う
            const csvFileInput = document.getElementById('csvFile');
            const loadCsvButton = document.getElementById('loadCsvButton');
            let selectedCsvFile = null;

            if (csvFileInput && loadCsvButton) {
                csvFileInput.addEventListener('change', (event) => {
                    selectedCsvFile = event.target.files[0];
                    loadCsvButton.disabled = !selectedCsvFile;
                });

                loadCsvButton.addEventListener('click', () => {
                    if (!selectedCsvFile) {
                        alert('CSVファイルを選択してください。');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            parseAndDisplayCsv(event.target.result);
                        } catch (error) {
                            console.error('CSV処理エラー:', error);
                            alert('CSV処理エラー。\nフォーマット確認してください。');
                        }
                    };
                    reader.onerror = () => {
                        alert('ファイル読込失敗。');
                    };
                    reader.readAsText(selectedCsvFile, 'UTF-8');
                });
            } else {
                console.error("CSV関連のDOM要素 (csvFileまたはloadCsvButton) が見つかりません。");
            }

            // その他の要素取得
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendMessageButton = document.getElementById('sendMessageButton');
            const speakerSelector = document.getElementById('speakerSelector');
            const prepareScreenshotButton = document.getElementById('prepareScreenshotButton');
            const womanAvatarUrlInput = document.getElementById('womanAvatarUrl');
            const setWomanAvatarButton = document.getElementById('setWomanAvatarButton');
            const imageFileInput = document.getElementById('imageFile');
            const insertImageButton = document.getElementById('insertImageButton');
            
            let pendingImageToInsert = null; 

            const users = {
                man: { name: '男性', avatar: 'https://placehold.co/40x40/A0C4FF/FFFFFF?text=男' },
                woman: { name: '女性', avatar: 'https://placehold.co/40x40/FFB3C6/FFFFFF?text=女' }
            };
            
            // 女性アバター設定
            if (setWomanAvatarButton && womanAvatarUrlInput) {
                setWomanAvatarButton.addEventListener('click', () => {
                    const newAvatarUrl = womanAvatarUrlInput.value.trim();
                    if (newAvatarUrl) {
                        users.woman.avatar = newAvatarUrl; 
                        const existingWomanAvatars = chatMessages.querySelectorAll('.message.received.woman .avatar');
                        existingWomanAvatars.forEach(avatarElement => { avatarElement.style.backgroundImage = `url('${newAvatarUrl}')`;});
                        alert('女性のアイコンを設定しました。');
                    } else { alert('アイコンのURLを入力してください。');}
                });
            }

            // 画像挿入関連
            if (insertImageButton && imageFileInput) {
                insertImageButton.addEventListener('click', () => {
                    if (pendingImageToInsert) { 
                        cancelImageInsertion();
                    } else { 
                        imageFileInput.click(); 
                    }
                });

                imageFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const selectedSpeakerValue = speakerSelector.value;
                    if (!users[selectedSpeakerValue]) {
                        alert('話者を選択してください。');
                        imageFileInput.value = ''; 
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        pendingImageToInsert = {
                            dataUrl: e.target.result,
                            speakerKey: selectedSpeakerValue
                        };
                        displayInsertionMarkers();
                        insertImageButton.textContent = '画像挿入をキャンセル';
                        insertImageButton.classList.add('cancel-mode');
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            function displayInsertionMarkers() {
                removeInsertionMarkers(); 
                const createMarker = (referenceNode = null) => {
                    const marker = document.createElement('div');
                    marker.classList.add('insertion-marker');
                    marker.textContent = 'ここに画像を挿入';
                    marker.onclick = () => {
                        if (pendingImageToInsert) {
                            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            addMessageToScreen('image', pendingImageToInsert.dataUrl, pendingImageToInsert.speakerKey, timestamp, users[pendingImageToInsert.speakerKey], referenceNode);
                            cancelImageInsertion();
                        }
                    };
                    return marker;
                };
                const messages = chatMessages.querySelectorAll('.message');
                messages.forEach(msgElement => { chatMessages.insertBefore(createMarker(msgElement), msgElement);});
                chatMessages.appendChild(createMarker(null));
            }

            function removeInsertionMarkers() {
                const markers = chatMessages.querySelectorAll('.insertion-marker');
                markers.forEach(marker => marker.remove());
            }

            function cancelImageInsertion() {
                pendingImageToInsert = null;
                removeInsertionMarkers();
                insertImageButton.textContent = '画像を選択して挿入位置を指定';
                insertImageButton.classList.remove('cancel-mode');
                if(imageFileInput) imageFileInput.value = ''; 
            }
            
            // スクリーンショット準備
            if (prepareScreenshotButton) {
                prepareScreenshotButton.addEventListener('click', () => {
                    const chatContentHtml = chatMessages.innerHTML;
                    let styles = "";
                    const styleElements = document.head.getElementsByTagName('style');
                    for (let i = 0; i < styleElements.length; i++) {
                        styles += styleElements[i].innerHTML;
                    }

                    const printWindow = window.open('', '_blank', 'width=800,height=600');
                    if (printWindow) {
                        printWindow.document.write('<html><head><title>チャット内容の印刷/保存</title>');
                        printWindow.document.write('<style>');
                        printWindow.document.write(styles); 
                        printWindow.document.write(`
                            /* 印刷準備ウィンドウ専用のスタイル */
                            body { 
                                margin: 0 !important; 
                                padding: 0 !important; 
                                background-color: rgb(140, 171, 217) !important;  /* 指定されたRGB値に変更 */
                            }
                            .print-wrapper { 
                                max-width: 450px; 
                                margin: 20px auto; 
                                padding: 0; 
                                background-color: rgb(140, 171, 217); /* 指定されたRGB値に変更 */
                                box-sizing: border-box;
                            }
                            .chat-messages { 
                                overflow-y: visible !important; 
                                height: auto !important; 
                                width: 100% !important; 
                                padding: 10px 15px !important; 
                                box-sizing: border-box;
                                background-color: rgb(140, 171, 217) !important; /* 指定されたRGB値に変更 */
                            }
                            .message.sent {
                                padding-left: 10px !important; 
                            }
                             .message.received {
                                padding-right: 10px !important; 
                            }
                            .insertion-marker { display: none !important; } 

                            @media print {
                                body { 
                                    margin: 10mm !important; 
                                    font-size: 9pt; 
                                    -webkit-print-color-adjust: exact !important; 
                                    color-adjust: exact !important; 
                                }
                                .print-wrapper {
                                    margin: 0 !important; 
                                    box-shadow: none !important;
                                }
                                .chat-messages { 
                                    page-break-inside: avoid;
                                    background-color: rgb(140, 171, 217) !important; /* 指定されたRGB値に変更 */
                                }
                                .message {
                                    page-break-inside: avoid;
                                    margin-bottom: 2mm; 
                                }
                                .bubble, .chat-image-link {
                                   box-shadow: none !important; 
                                }
                                .chat-image-link {
                                    max-width: 90%; 
                                    margin: 5px auto; 
                                }
                                @page {
                                    size: a4 portrait; 
                                    margin: 10mm;
                                }
                            }
                        `);
                        printWindow.document.write('</style></head><body>');
                        printWindow.document.write('<div class="print-wrapper">'); 
                        printWindow.document.write('<div class="chat-messages">'); 
                        printWindow.document.write(chatContentHtml); 
                        printWindow.document.write('</div>');
                        printWindow.document.write('</div>'); 
                        printWindow.document.write('<p style="font-size: x-small; text-align: center; margin-top: 15px; color: #333;">注: チャットが非常に長い場合、複数ページに分割されることがあります。ブラウザの印刷設定で「背景画像を印刷する」オプションを確認し、縮小率やレイアウトを調整してください。</p>');
                        printWindow.document.write('</body></html>');
                        printWindow.document.close(); 
                        
                        setTimeout(() => {
                            printWindow.focus(); 
                            printWindow.print(); 
                        }, 700); 
                    } else {
                        alert('ポップアップウィンドウがブロックされた可能性があります。ポップアップを許可してください。');
                    }
                });
            }

            // CSVパースと表示
            function parseAndDisplayCsv(csvText) {
                const lines = csvText.split(/\r\n|\n/);
                if (lines.length < 2) { alert('CSVデータ不足。'); return; }
                const header = lines[0].split(',').map(h => h.trim().toLowerCase());
                const speakerHeaderName = 'sender'; const messageHeaderName = 'text'; const timestampHeaderName = 'timestamp';
                const speakerIndex = header.indexOf(speakerHeaderName); const messageIndex = header.indexOf(messageHeaderName); const timestampIndex = header.indexOf(timestampHeaderName);
                if (speakerIndex === -1 || messageIndex === -1) { alert(`ヘッダーに "${speakerHeaderName}" と "${messageHeaderName}" が必要です。`); return; }
                chatMessages.innerHTML = ''; 
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i]; if (line.trim() === '') continue;
                    const values = line.split(','); 
                    const csvSpeaker = values[speakerIndex]?.trim(); let messageText = values[messageIndex]?.trim(); let timestamp = timestampIndex !== -1 ? values[timestampIndex]?.trim() : null;
                    if (messageText && messageText.startsWith('"') && messageText.endsWith('"')) { messageText = messageText.substring(1, messageText.length - 1).replace(/""/g, '"');}
                    if (!csvSpeaker || !messageText) { console.warn(`行 ${i+1} データ不足: ${line}`); continue; }
                    let internalSpeakerKey = '';
                    if (csvSpeaker === '男') internalSpeakerKey = 'man'; else if (csvSpeaker === '女') internalSpeakerKey = 'woman'; else { console.warn(`行 ${i+1} 話者不明 "${csvSpeaker}"`); continue; }
                    if (!users[internalSpeakerKey]) { console.warn(`行 ${i+1} 話者キー "${internalSpeakerKey}" 未定義`); continue; }
                    if (!timestamp) timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    addMessageToScreen('text', messageText, internalSpeakerKey, timestamp, users[internalSpeakerKey]); 
                }
                if(csvFileInput) csvFileInput.value = ''; 
                selectedCsvFile = null; 
                if(loadCsvButton) loadCsvButton.disabled = true;
            }

            // 手動メッセージ送信
            if (sendMessageButton && messageInput && speakerSelector) {
                sendMessageButton.addEventListener('click', handleManualMessageSend);
                messageInput.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleManualMessageSend(); }
                });
            }
            function handleManualMessageSend() { 
                const messageText = messageInput.value.trim();
                const selectedSpeakerValue = speakerSelector.value;
                const currentUser = users[selectedSpeakerValue];
                if (messageText === '' || !currentUser) return;
                const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                addMessageToScreen('text', messageText, selectedSpeakerValue, timestamp, currentUser);
                messageInput.value = ''; messageInput.focus();
            }
            
            // メッセージを画面に追加する共通関数
            function addMessageToScreen(type, content, speakerKey, time, speakerInfo, referenceNode = null) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');

                const avatarDiv = document.createElement('div');
                avatarDiv.classList.add('avatar');
                avatarDiv.style.backgroundImage = `url('${speakerInfo.avatar}')`;

                let messageContentElement; 

                if (type === 'text') {
                    const bubbleDiv = document.createElement('div');
                    bubbleDiv.classList.add('bubble');
                    const linkedText = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                    bubbleDiv.innerHTML = linkedText.replace(/\n/g, '<br>');
                    messageContentElement = bubbleDiv;
                } else if (type === 'image') {
                    const imageLink = document.createElement('a');
                    imageLink.href = content; 
                    imageLink.target = '_blank';
                    imageLink.classList.add('chat-image-link');
                    const imgElement = document.createElement('img');
                    imgElement.classList.add('chat-image');
                    imgElement.src = content;
                    imgElement.alt = 'チャット画像';
                    imageLink.appendChild(imgElement);
                    messageContentElement = imageLink;
                }

                const timestampDiv = document.createElement('div');
                timestampDiv.classList.add('timestamp');
                timestampDiv.textContent = time;

                if (speakerKey === 'man') { 
                    messageDiv.classList.add('sent', 'man');
                    const statusTimestampWrapper = document.createElement('div');
                    statusTimestampWrapper.classList.add('status-timestamp-wrapper');
                    const readStatusDiv = document.createElement('div');
                    readStatusDiv.classList.add('read-status');
                    readStatusDiv.textContent = '既読';
                    statusTimestampWrapper.appendChild(readStatusDiv);
                    statusTimestampWrapper.appendChild(timestampDiv); 
                    messageDiv.appendChild(statusTimestampWrapper); 
                    messageDiv.appendChild(messageContentElement); 
                } else { 
                    messageDiv.classList.add('received', 'woman');
                    messageDiv.appendChild(avatarDiv);
                    messageDiv.appendChild(messageContentElement); 
                    messageDiv.appendChild(timestampDiv); 
                }
                
                if (referenceNode) {
                    chatMessages.insertBefore(messageDiv, referenceNode);
                } else {
                    chatMessages.appendChild(messageDiv);
                }
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
            }
        });
    </script>
</body>
</html>
