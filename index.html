<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE風チャットアプリ (時刻入力・日付区切り機能付き)</title>
    <style>
        /* 全体のスタイル */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            margin: 0;
            background-color: #7b99c1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        /* 操作エリアの共通スタイル */
        .action-area {
            background-color: #f0f0f0;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column; 
            gap: 10px; 
            width: 100%;
            max-width: 450px;
        }
        .action-area .input-group { 
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .action-area label {
            font-size: 0.9em;
            margin-right: 5px;
            white-space: nowrap; 
        }
        .action-area input[type="file"],
        .action-area input[type="text"] { 
            font-size: 0.9em;
            border: 1px solid #ccc;
            padding: 5px 8px;
            border-radius: 4px;
            flex-grow: 1; 
            min-width: 80px; /* 時刻入力欄も考慮 */
        }
        .action-area input[placeholder*="時刻"] { /* 時刻入力欄の幅調整 */
            flex-grow: 0.5;
            min-width: 80px;
        }
        .action-area button {
            padding: 8px 12px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            align-self: flex-start; 
        }
        .action-area button:disabled { background-color: #ccc; cursor: not-allowed; }

        #loadCsvButton { background-color: #28a745; } #loadCsvButton:hover { background-color: #218838; }
        #prepareScreenshotButton { background-color: #007bff; } #prepareScreenshotButton:hover { background-color: #0056b3; }
        #setWomanAvatarButton { background-color: #ffc107; color: #212529;} #setWomanAvatarButton:hover { background-color: #e0a800; }
        #insertImageButton { background-color: #17a2b8; } #insertImageButton.cancel-mode { background-color: #dc3545; } 
        #insertImageButton:hover { background-color: #138496; } #insertImageButton.cancel-mode:hover { background-color: #c82333; }

        .chat-container {
            width: 100%; max-width: 450px; height: 55vh; max-height: 500px; /* 高さを少し調整 */
            background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .chat-header {
            background-color: #3d414d; color: white; padding: 15px 20px; text-align: center;
            font-size: 1.1em; font-weight: bold; border-bottom: 1px solid #353842;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .chat-header .status-icons { font-size: 0.9em; opacity: 0.8; }

        .chat-messages {
            flex-grow: 1; padding: 10px 15px; overflow-y: auto; display: flex; flex-direction: column;
            background-color: rgb(140, 171, 217); gap: 5px;
        }

        .chat-messages::after {
            content: "";
            display: block;
            /* / ← 欲しい余白分 */
            height: 80px; 
            /* / 折りたたまれ防止 */
            flex-shrink: 0; 
        }
        
        
        /* 日付区切り線のスタイル */
        .date-separator {
            text-align: center;
            margin: 15px auto 10px auto; /* 上下マージンと左右autoで中央寄せ */
            font-size: 0.75em;
            color: white;
            background-color: rgba(0, 0, 0, 0.2); /* 半透明の濃いグレー */
            padding: 3px 12px;
            border-radius: 12px;
            display: inline-block; /* widthを内容に合わせる */
            clear: both; /* floatの影響を避ける */
            align-self: center; /* flexコンテナ内で中央に */
        }

        .message { display: flex; max-width: 100%; margin-bottom: 10px; align-items: flex-end; box-sizing: border-box; }
        .message .avatar { width: 40px; height: 40px; border-radius: 50%; background-size: cover; background-position: center; flex-shrink: 0; margin-bottom: 5px; }
        .message .bubble { padding: 10px 15px; border-radius: 16px; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); max-width: 75%; }
        .message.sent .bubble::after { content: ''; position: absolute; top: 8px; right: -8px; width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-left: 10px solid #8de048; }
        .message.received .bubble::before { content: ''; position: absolute; top: 8px; left: -8px; width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-right: 10px solid #ffffff; }
        .chat-image-link { display: block; max-width: 70%; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
        .chat-image { max-width: 100%; display: block; border-radius: 10px; }
        .insertion-marker { background-color: rgba(76, 175, 80, 0.8); color: white; padding: 6px 0; margin: 3px 0; border-radius: 4px; cursor: pointer; text-align: center; font-size: 0.8em; border: 1px dashed #fff; transition: background-color 0.2s ease; }
        .insertion-marker:hover { background-color: rgba(69, 160, 73, 0.9); }
        .message.received .speaker-name { display: none; }
        .message .timestamp { font-size: 0.65em; color: #777; white-space: nowrap; margin-bottom: 5px; }
        .message.sent .status-timestamp-wrapper { display: flex; flex-direction: column; align-items: flex-end; margin-right: 5px; }
        .message.sent .read-status { font-size: 0.6em; color: #777; margin-bottom: 0.6px; }
        .message.sent { justify-content: flex-end; padding-left: 10px; }
        .message.sent .bubble, .message.sent .chat-image-link { background-color: #8de048; }
        .message.sent .avatar { display: none; }
        .message.received { justify-content: flex-start; padding-right: 10px; }
        .message.received .avatar { margin-right: 10px; }
        .message.received .bubble, .message.received .chat-image-link { background-color: #ffffff; margin-left: 10px; }
        .message.received .chat-image-link { margin-left: 0; }
        .message.received .timestamp { margin-left: 5px; }

        .chat-input-area {
            display: flex; padding: 10px 15px; border-top: 1px solid #ddd; background-color: #f5f5f5;
            align-items: center; gap: 8px; /* Gapを少し調整 */ flex-shrink: 0;
        }
        #speakerSelector { padding: 10px; border-radius: 20px; border: 1px solid #ccc; background-color: white; font-size: 0.9em; flex-shrink: 0; }
        #messageInput { flex-grow: 1; padding: 12px 18px; border: 1px solid #ccc; border-radius: 20px; font-size: 1em; outline: none; }
        #customMessageTimeInput { /* 新しい時刻入力欄のスタイル */
            padding: 10px; border-radius: 20px; border: 1px solid #ccc; font-size: 0.8em; width: 80px; text-align: center;
        }
        #sendMessageButton { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 1.2em; cursor: pointer; transition: background-color 0.2s ease; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        #sendMessageButton:hover { background-color: #0056b3; }
        #sendMessageButton svg { width: 20px; height: 20px; fill: white; }

        @media (max-width: 480px) { /* 省略 */ }
    </style>
</head>
<body>
    <div class="action-area">
        <div class="input-group">
            <label for="csvFile">CSV読込:</label>
            <input type="file" id="csvFile" accept=".csv,text/csv">
            <button id="loadCsvButton" disabled>読込実行</button>
        </div>
        <div class="input-group">
            <label for="womanAvatarUrl">女性アイコンURL:</label>
            <input type="text" id="womanAvatarUrl" placeholder="画像のURLを入力">
            <button id="setWomanAvatarButton">設定</button>
        </div>
        <div class="input-group"> 
            <label for="imageFile">画像挿入:</label>
            <input type="file" id="imageFile" accept="image/*" style="display: none;"> 
            <input type="text" id="customImageTimeInput" placeholder="時刻 (例:10:30)"> {/* 画像用の時刻入力 */}
            <button id="insertImageButton">選択して挿入場所を指定</button>
        </div>
        <div class="input-group"> 
             <button id="prepareScreenshotButton" style="width: auto;">チャットを画像/PDFで保存準備</button>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header"> /* ... */ </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <select id="speakerSelector">
                <option value="man">男性</option>
                <option value="woman">女性</option>
            </select>
            <input type="text" id="messageInput" placeholder="メッセージを入力...">
            <input type="text" id="customMessageTimeInput" placeholder="時刻"> {/* テキストメッセージ用の時刻入力 */}
            <button id="sendMessageButton" title="送信">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 要素取得 (主要なもの) ---
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const customMessageTimeInput = document.getElementById('customMessageTimeInput'); // テキストメッセージ用時刻入力
            const sendMessageButton = document.getElementById('sendMessageButton');
            const speakerSelector = document.getElementById('speakerSelector');
            const csvFileInput = document.getElementById('csvFile');
            const loadCsvButton = document.getElementById('loadCsvButton');
            const womanAvatarUrlInput = document.getElementById('womanAvatarUrl');
            const setWomanAvatarButton = document.getElementById('setWomanAvatarButton');
            const imageFileInput = document.getElementById('imageFile');
            const customImageTimeInput = document.getElementById('customImageTimeInput'); // 画像用時刻入力
            const insertImageButton = document.getElementById('insertImageButton');
            const prepareScreenshotButton = document.getElementById('prepareScreenshotButton');
            
            let selectedCsvFile = null;
            let pendingImageToInsert = null; 
            let lastProcessedDateString = null; // 最後に処理されたメッセージの日付文字列 (YYYY-MM-DD)

            const users = { /* ... */ };
            
            // --- Helper Functions ---
            function getFormattedTimestamp(dateObj) {
                return dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            function parseTimeToDate(timeStr, baseDate = new Date()) {
                const newDate = new Date(baseDate);
                if (timeStr) {
                    const timeParts = timeStr.match(/^(\d{1,2}):(\d{2})$/);
                    if (timeParts) {
                        newDate.setHours(parseInt(timeParts[1], 10), parseInt(timeParts[2], 10), 0, 0);
                        return newDate;
                    }
                    // 簡単な日付時刻文字列のパース試行 (例: "2023-10-27 10:30", "10/27 10:30")
                    const parsedDate = new Date(timeStr);
                    if (!isNaN(parsedDate.valueOf()) && timeStr.includes(":")) { // 有効な日付かつ時刻情報がありそうなら
                         if(!timeStr.match(/[年月日の]/) && timeStr.match(/^\d{1,2}:\d{2}$/)) { // "10:30" のような形式なら今日の日にちを維持
                            newDate.setHours(parsedDate.getHours(), parsedDate.getMinutes(), parsedDate.getSeconds(), parsedDate.getMilliseconds());
                            return newDate;
                         }
                        return parsedDate;
                    }
                }
                return baseDate; // パース失敗または入力なしならベースデート (通常は現在時刻)
            }
            
            function formatDateForSeparator(dateObj) {
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(today.getDate() - 1);

                if (dateObj.toDateString() === today.toDateString()) return '今日';
                if (dateObj.toDateString() === yesterday.toDateString()) return '昨日';
                
                const M = dateObj.getMonth() + 1;
                const D = dateObj.getDate();
                const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
                const day = dayNames[dateObj.getDay()];
                return `${dateObj.getFullYear()}年${M}月${D}日 (${day})`;
            }

            // --- イベントリスナー ---
            if (csvFileInput && loadCsvButton) { /* ... (変更なし) */ }
            if (setWomanAvatarButton && womanAvatarUrlInput) { /* ... (変更なし) */ }
            if (prepareScreenshotButton) { /* ... (変更なし) */ }

            if (insertImageButton && imageFileInput) {
                insertImageButton.addEventListener('click', () => { /* ... (変更なし) */ });
                imageFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const selectedSpeakerValue = speakerSelector.value;
                    if (!users[selectedSpeakerValue]) { /* ... */ return; }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const customTimeStr = customImageTimeInput.value.trim();
                        const actualDateTime = parseTimeToDate(customTimeStr, new Date());
                        const displayTime = customTimeStr || getFormattedTimestamp(actualDateTime);

                        pendingImageToInsert = {
                            dataUrl: e.target.result,
                            speakerKey: selectedSpeakerValue,
                            actualDateTime: actualDateTime, // actualDateTime を保存
                            displayTime: displayTime        // displayTime を保存
                        };
                        displayInsertionMarkers();
                        insertImageButton.textContent = '画像挿入をキャンセル';
                        insertImageButton.classList.add('cancel-mode');
                        customImageTimeInput.value = ''; // 入力欄クリア
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            function displayInsertionMarkers() {
                removeInsertionMarkers(); 
                const createMarker = (referenceNode = null) => {
                    const marker = document.createElement('div');
                    marker.classList.add('insertion-marker');
                    marker.textContent = 'ここに画像を挿入';
                    marker.onclick = () => {
                        if (pendingImageToInsert) {
                            addMessageToScreen(
                                'image', 
                                pendingImageToInsert.dataUrl, 
                                pendingImageToInsert.speakerKey, 
                                pendingImageToInsert.actualDateTime, // actualDateTime を渡す
                                pendingImageToInsert.displayTime,    // displayTime を渡す
                                users[pendingImageToInsert.speakerKey],
                                referenceNode 
                            );
                            cancelImageInsertion();
                        }
                    };
                    return marker;
                };
                // ... (マーカー挿入ロジックは変更なし)
                 const messages = chatMessages.querySelectorAll('.message');
                messages.forEach(msgElement => { chatMessages.insertBefore(createMarker(msgElement), msgElement);});
                chatMessages.appendChild(createMarker(null));
            }
            function removeInsertionMarkers() { /* ... (変更なし) */ }
            function cancelImageInsertion() { /* ... (変更なし) */ }
            
            // --- メッセージ送信関連 ---
            if (sendMessageButton && messageInput && speakerSelector && customMessageTimeInput) {
                sendMessageButton.addEventListener('click', handleManualMessageSend);
                messageInput.addEventListener('keypress', (event) => { /* ... */ });
            }
            function handleManualMessageSend() { 
                const messageText = messageInput.value.trim();
                const customTimeStr = customMessageTimeInput.value.trim();
                const selectedSpeakerValue = speakerSelector.value;
                const currentUser = users[selectedSpeakerValue];

                if (messageText === '' || !currentUser) return;

                const actualDateTime = parseTimeToDate(customTimeStr, new Date());
                const displayTime = customTimeStr || getFormattedTimestamp(actualDateTime);
                
                addMessageToScreen('text', messageText, selectedSpeakerValue, actualDateTime, displayTime, currentUser);
                messageInput.value = ''; 
                customMessageTimeInput.value = ''; // 時刻入力欄もクリア
                messageInput.focus();
            }
            
            // --- CSVパースと表示 ---
            function parseAndDisplayCsv(csvText) {
                // ... (ヘッダー処理など)
                chatMessages.innerHTML = ''; 
                lastProcessedDateString = null; // CSV読み込み時にリセット

                for (let i = 1; i < lines.length; i++) {
                    // ... (行データ取得)
                    let csvTimestampStr = timestampIndex !== -1 ? values[timestampIndex]?.trim() : null;
                    let actualDateTime = parseTimeToDate(csvTimestampStr, new Date()); // CSVの時刻をパース
                    let displayTime = csvTimestampStr || getFormattedTimestamp(actualDateTime);
                    if(csvTimestampStr && !csvTimestampStr.includes(':')) { // 時刻情報がないただの文字列ならそのまま表示、日時は現在
                        displayTime = csvTimestampStr;
                        actualDateTime = new Date(); // 判定用に現在日時を使う
                    }


                    addMessageToScreen('text', messageText, internalSpeakerKey, actualDateTime, displayTime, users[internalSpeakerKey]); 
                }
                // ...
            }

            // --- メッセージを画面に追加する共通関数 ---
            // 引数に actualDateTime (Date object) と displayTime (string) を追加
            function addMessageToScreen(type, content, speakerKey, actualDateTime, displayTime, speakerInfo, referenceNode = null) {
                const currentMessageDateStr = actualDateTime.toISOString().split('T')[0]; // YYYY-MM-DD形式

                // 日付区切り線のチェックと挿入
                if (lastProcessedDateString !== currentMessageDateStr) {
                    const dateSeparatorDiv = document.createElement('div');
                    dateSeparatorDiv.classList.add('date-separator');
                    dateSeparatorDiv.textContent = formatDateForSeparator(actualDateTime);
                    
                    if (referenceNode) {
                        chatMessages.insertBefore(dateSeparatorDiv, referenceNode);
                    } else {
                        chatMessages.appendChild(dateSeparatorDiv);
                    }
                    lastProcessedDateString = currentMessageDateStr;
                }

                const messageDiv = document.createElement('div');
                // ... (以降のメッセージ要素生成は変更なし、ただしtimestampDiv.textContent = displayTime; にする)
                messageDiv.classList.add('message');
                const avatarDiv = document.createElement('div'); /* ... */
                avatarDiv.classList.add('avatar');
                avatarDiv.style.backgroundImage = `url('${speakerInfo.avatar}')`;

                let messageContentElement; 
                if (type === 'text') { /* ... */ 
                    const bubbleDiv = document.createElement('div');
                    bubbleDiv.classList.add('bubble');
                    const linkedText = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                    bubbleDiv.innerHTML = linkedText.replace(/\n/g, '<br>');
                    messageContentElement = bubbleDiv;
                } else if (type === 'image') { /* ... */ 
                    const imageLink = document.createElement('a');
                    imageLink.href = content; 
                    imageLink.target = '_blank';
                    imageLink.classList.add('chat-image-link');
                    const imgElement = document.createElement('img');
                    imgElement.classList.add('chat-image');
                    imgElement.src = content;
                    imgElement.alt = 'チャット画像';
                    imageLink.appendChild(imgElement);
                    messageContentElement = imageLink;
                }

                const timestampDiv = document.createElement('div');
                timestampDiv.classList.add('timestamp');
                timestampDiv.textContent = displayTime; // 表示用の時刻文字列を使用

                if (speakerKey === 'man') { /* ... */ 
                     messageDiv.classList.add('sent', 'man');
                    const statusTimestampWrapper = document.createElement('div');
                    statusTimestampWrapper.classList.add('status-timestamp-wrapper');
                    const readStatusDiv = document.createElement('div');
                    readStatusDiv.classList.add('read-status');
                    readStatusDiv.textContent = '既読';
                    statusTimestampWrapper.appendChild(readStatusDiv);
                    statusTimestampWrapper.appendChild(timestampDiv); 
                    messageDiv.appendChild(statusTimestampWrapper); 
                    messageDiv.appendChild(messageContentElement); 
                } else { /* ... */ 
                    messageDiv.classList.add('received', 'woman');
                    messageDiv.appendChild(avatarDiv);
                    messageDiv.appendChild(messageContentElement); 
                    messageDiv.appendChild(timestampDiv); 
                }
                
                if (referenceNode) {
                    chatMessages.insertBefore(messageDiv, referenceNode);
                } else {
                    chatMessages.appendChild(messageDiv);
                }
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
            }

            // 既存のCSVパースや手動送信関数内でaddMessageToScreenを呼び出す際、
            // 第4引数にDateオブジェクト、第5引数に表示用時刻文字列を渡すように修正が必要
            // (上記コード内で一部修正済み)
        });
    </script>
</body>
</html>
